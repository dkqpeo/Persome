<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ì¿ í° | Persome</title>
    <style>
        body{font-family:"Noto Sans KR",Arial,sans-serif;margin:0;background:#fff}
        .container{max-width:1100px;margin:20px auto;padding:0 16px}
        .hello .name{font-size:20px;font-weight:800;color:#222}
        .grid{display:grid;grid-template-columns:260px 1fr;gap:24px;margin-top:18px}
        .card{border:1px solid #eee;border-radius:12px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.04)}
        .card .hd{padding:14px 16px;border-bottom:1px solid #f0f0f0;font-weight:700}
        .card .bd{padding:16px}
        .menu li a{display:block;padding:12px 14px;text-decoration:none;color:#333;border-radius:8px;font-size:15px;font-weight:500;transition:0.2s}
        .menu li a:hover{background:#F6F3FF;color:#A68DC0;font-weight:600}
        .card .hd a{font-size:18px;font-weight:700;text-decoration:none;color:#222}
        .card .hd a:hover{color:#A68DC0}
        .coupon{position:relative;border:1px solid #A68DC0;border-radius:12px;padding:16px;margin-bottom:14px;background:linear-gradient(90deg,rgba(166,141,192,0.08),#fff);display:flex;justify-content:space-between;align-items:center;transition:0.2s}
        .coupon:hover{box-shadow:0 4px 12px rgba(166,141,192,0.2);transform:translateY(-2px)}
        .coupon::before,.coupon::after{content:"";position:absolute;top:50%;width:18px;height:18px;background:#fff;border:1px solid #A68DC0;border-radius:50%;transform:translateY(-50%)}
        .coupon::before{left:-10px}
        .coupon::after{right:-10px}
        .coupon .name{font-size:16px;font-weight:700;color:#4C3579;margin-bottom:6px}
        .coupon .discount{font-size:22px;font-weight:800;color:#A68DC0}
        .coupon .meta{font-size:12px;color:#777;margin-top:4px}
        .coupon.expired{border-color:#ccc;background:#f9f9f9;color:#aaa}
        .coupon.expired .name,.coupon.expired .discount,.coupon.expired .meta{color:#aaa}
        .mt16{margin-top:16px}
        @media(max-width:768px){.grid{grid-template-columns:1fr}.summary{grid-template-columns:1fr}}
    </style>
    <link rel="stylesheet" href="/css/header.css">
</head>
<body>
<div id="header"></div>
<div id="siteHeader"></div>
<div class="container">
    <div id="hero"></div>
    <div id="kpi"></div>
    <div class="grid">
        <div id="sidebar"></div>
        <div>
            <section>
                <div class="card">
                    <div class="hd">ë³´ìœ  ì¿ í°</div>
                    <div class="bd" id="couponList">
                        <div class="muted">ë¡œë”© ì¤‘â€¦</div>
                    </div>
                </div>
                <div class="card" style="margin-top:14px;">
                    <div class="hd">ì‚¬ìš© ê°€ëŠ¥ ì¿ í°</div>
                    <div class="bd" id="availableList">
                        <div class="muted">ë¡œë”© ì¤‘â€¦</div>
                    </div>
                </div>
            </section>
        </div>
    </div>
    <div id="mpAlert" class="muted mt16"></div>
</div>
<script src="/js/header.js"></script>
<script src="/js/fragment-loader.js"></script>
<script src="/js/mypage/mypage.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const couponList = document.getElementById("couponList");
        const availableList = document.getElementById("availableList");

        function formatDate(dateStr) {
            if (!dateStr) return "-";
            return new Date(dateStr).toISOString().split("T")[0]; // YYYY-MM-DD
        }

        //ì‚¬ìš©ì ì „ì²´ ì¿ í° ì¡°íšŒ
        async function loadUserCoupons() {
            try {
                const res = await fetch("/api/users/me/coupons", {credentials: "include"});
                if (!res.ok) throw new Error("ì¿ í°ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                const {data} = await res.json();

                if (!data || data.length === 0) {
                    couponList.innerHTML = `<div class="muted">ë³´ìœ í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                    return;
                }
                //ì •ë ¬: ì‚¬ìš© ê°€ëŠ¥ â†’ ë§Œë£Œ/ì‚¬ìš©ì™„ë£Œ ìˆœ
                const sorted = [...data].sort((a, b) => {
                    const aExpired = a.status === "ë§Œë£Œë¨" || a.status === "ì‚¬ìš©ì™„ë£Œ";
                    const bExpired = b.status === "ë§Œë£Œë¨" || b.status === "ì‚¬ìš©ì™„ë£Œ";
                    if (aExpired === bExpired) return 0;
                    return aExpired ? 1 : -1; // ë§Œë£Œëœ ê±´ ë’¤ë¡œ
                });

                couponList.innerHTML = sorted.map(coupon => {
                    const isExpired = coupon.status === 'ë§Œë£Œë¨' || coupon.status === 'ì‚¬ìš©ì™„ë£Œ';
                    return `
                        <div class="coupon ${isExpired ? 'expired' : ''}">
                          <div>
                            <div class="name">${coupon.couponName}</div>
                            <div class="discount">
                                ${coupon.discountType === "RATE"
                                    ? (coupon.discountValue * 100).toFixed(0) + "%" // ğŸ‘ˆ ì •ìˆ˜ í¼ì„¼íŠ¸ë¡œ ë³€í™˜
                                    : coupon.discountValue.toLocaleString() + "ì›"} í• ì¸
                            </div>
                            <div class="meta">
                              ì‚¬ìš©ê¸°ê°„: ${formatDate(coupon.startDate)} ~ ${formatDate(coupon.endDate)} | ${coupon.status}
                            </div>
                          </div>
                        </div>
                      `;
                }).join("");
            } catch (err) {
                console.error(err);
                couponList.innerHTML = `<div class="muted">ì¿ í° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>`;
            }
        }

        //ì ìš© ê°€ëŠ¥í•œ ì¿ í° ì¡°íšŒ
        async function loadAvailableCoupons() {
            try {
                const res = await fetch("/api/users/me/coupons/available", {credentials: "include"});
                if (!res.ok) throw new Error("ì ìš© ê°€ëŠ¥í•œ ì¿ í°ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                const {data} = await res.json();

                if (!data || data.length === 0) {
                    availableList.innerHTML = `<div class="muted">ì ìš© ê°€ëŠ¥í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                    return;
                }

                availableList.innerHTML = data.map(coupon => `
                    <div class="coupon">
                      <div>
                        <div class="name">${coupon.couponName}</div>
                        <div class="discount">
                            ${coupon.discountType === "RATE"
                                ? (coupon.discountValue * 100).toFixed(0) + "%" // ğŸ‘ˆ ì •ìˆ˜ í¼ì„¼íŠ¸ë¡œ ë³€í™˜
                                : coupon.discountValue.toLocaleString() + "ì›"} í• ì¸
                        </div>
                        <div class="meta">
                          ì‚¬ìš©ê¸°ê°„: ${formatDate(coupon.startDate)} ~ ${formatDate(coupon.endDate)}
                        </div>
                      </div>
                    </div>
                `).join("");
            } catch (err) {
                console.error(err);
                availableList.innerHTML = `<div class="muted">ì ìš© ê°€ëŠ¥ ì¿ í° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>`;
            }
        }

        // ì‹¤í–‰
        await loadUserCoupons();
        await loadAvailableCoupons();
    });
</script>

</body>
</html>
