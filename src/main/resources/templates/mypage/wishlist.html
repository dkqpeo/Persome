<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>마이페이지 | Persome</title>
    <style>
        body { font-family:"Noto Sans KR", Arial, sans-serif; margin:0; background:#fff; }
        .container { max-width: 1100px; margin: 20px auto; padding: 0 16px; }
        .hello .name { font-size:20px; font-weight:800; color:#222; }
        .grid { display:grid; grid-template-columns: 260px 1fr; gap: 24px; margin-top:18px; }
        .menu li a { display: block; padding: 12px 14px; text-decoration: none; color: #333; border-radius: 8px; font-size: 15px; font-weight: 500; transition: 0.2s; }
        .menu li a:hover { background: #F6F3FF; color: #A68DC0; font-weight: 600; }
        .card .hd a { font-size: 18px; font-weight: 700; text-decoration: none; color: #222; }
        .card .hd a:hover { color: #A68DC0; }

        .mt16 { margin-top:16px; }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }

        /* 위시리스트 관련 css */
        h2 { margin:0 0 20px; font-size:1.5em; font-weight:700; }
        .wishlist-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }

        .wishlist-count {
            font-weight: bold;
        }

        .btn-danger {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .btn-danger:hover { border-color:#A68DC0; color:#A68DC0; }
        table { width:100%; border-collapse:collapse; margin-top:10px; }
        th, td { padding:12px; border-bottom:1px solid #eee; text-align:left; }
        th { background:#fafafa; font-weight:600; }
        .product-box { display:flex; align-items:center; gap:16px; }
        .product-box img { width:100px; border-radius:8px; flex-shrink:0; }
        .product-info { display:flex; flex-direction:column; justify-content:center; }
        .product-info .brand { font-weight:600; font-size:0.95em; color:#333; margin-bottom:4px; }
        .product-info .name { font-size:0.9em; color:#444; line-height:1.4; white-space: normal; }

        .price-box { display:flex; flex-direction:column; justify-content:center; }
        .price { color:#e60023; font-weight:700; font-size:1.05em; }
        .original { color:#999; font-size:0.9em; text-decoration:line-through; margin-right:6px; }

        .delete-btn { background:#fff; border:1px solid #ddd; border-radius:6px; padding:6px 12px; cursor:pointer; font-size: 0.9em; }
        .delete-btn:hover { border-color:#A68DC0; color:#A68DC0; }

        .empty { padding:40px; text-align:center; color:#888; }
    </style>
    <link rel="stylesheet" href="/css/header.css">
</head>
<body>
<div id="header"></div>
<div id="siteHeader"></div>
<div class="container">
    <div id="hero"></div>
    <div id="kpi"></div>
    <div class="grid">
        <div id="sidebar"></div>
        <div>
            <section class="container">
                <h2>위시리스트</h2>
                <div class="wishlist-toolbar">
                    <div class="wishlist-count">전체 <span id="wishlistCount">0</span>개</div>
                    <button id="deleteAllBtn" class="btn btn-danger">전체 삭제</button>
                </div>
                <table id="wishlistTable">
                    <thead>
                    <tr>
                        <th>상품</th>
                        <th>가격</th>
                        <th>관리</th>
                    </tr>
                    </thead>
                    <tbody id="wishlistBody">
                    <tr><td colspan="3" class="empty">불러오는 중...</td></tr>
                    </tbody>
                </table>
            </section>
        </div>
    </div>
    <div id="mpAlert" class="muted mt16"></div>
</div>
<script src="/js/header.js"></script>
<script src="/js/fragment-loader.js"></script>
<script src="/js/mypage.js"></script>
<script>
    async function fetchWishlist() {
        try {
            const res = await fetch("/api/users/me/wishlist", { credentials: "include" });
            if (!res.ok) throw new Error("위시리스트 조회 실패");
            return await res.json();
        } catch (e) {
            console.error(e);
            return [];
        }
    }

    function renderWishlist(items) {
        const tbody = document.getElementById("wishlistBody");
        const countEl = document.getElementById("wishlistCount");

        if (countEl) {
            countEl.textContent = items ? items.length : 0;
        }

        if (!items || items.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3" class="empty">위시리스트에 담긴 상품이 없습니다.</td></tr>`;
            return;
        }
        tbody.innerHTML = items.map(item => `
        <tr>
            <td>
                <div class="product-box">
                    <img src="${item.productImageUrl}" alt="${item.productName}">
                    <div class="product-info">
                        <div class="brand">${item.brandName || ""}</div>
                        <div class="name">${item.productName}</div>
                    </div>
                </div>
            </td>
            <td>
                <div class="price-box">
                    <span class="original">${item.originalPrice.toLocaleString()}원</span>
                    <span class="price">${item.salePrice.toLocaleString()}원</span>
                </div>
            </td>
            <td>
                <button class="delete-btn" onclick="deleteWishlist(${item.productId})">삭제</button>
            </td>
        </tr>
    `).join("");
    }

    async function deleteWishlist(productId) {
        if (!confirm("위시리스트에서 삭제하시겠습니까?")) return;
        try {
            const res = await fetch(`/api/users/me/wishlist/${productId}`, {
                method: "DELETE",
                credentials: "include"
            });
            if (res.ok) {
                loadWishlist();

                updateWishlistKpi();
            } else {
                alert("삭제 실패");
            }
        } catch (e) {
            console.error(e);
            alert("삭제 중 오류 발생");
        }
    }

    async function updateWishlistKpi() {
        try {
            const res = await fetch("/api/users/me/wishlist/count", { credentials: "include" });
            if (res.ok) {
                document.getElementById("kpiWish").textContent = await res.text();
            }
        } catch (e) {
            console.error("KPI 업데이트 실패", e);
        }
    }

    async function loadWishlist() {
        const items = await fetchWishlist();
        renderWishlist(items);
    }

    document.addEventListener("DOMContentLoaded", () => {
        const deleteAllBtn = document.getElementById("deleteAllBtn");
        if (!deleteAllBtn) return;

        deleteAllBtn.addEventListener("click", async () => {
            if (!confirm("위시리스트의 모든 상품을 삭제하시겠습니까?")) return;

            try {
                const res = await fetch("/api/users/me/wishlist", {
                    method: "DELETE",
                    credentials: "include"
                });

                if (res.ok) {
                    alert("위시리스트가 모두 삭제되었습니다.");
                    location.reload(); // 새로고침해서 빈 화면 보여주기
                } else {
                    const err = await res.text();
                    alert("삭제 실패: " + err);
                }
            } catch (e) {
                console.error(e);
                alert("에러 발생: " + e.message);
            }
        });
    });


    loadWishlist();

</script>
</body>
</html>
