<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì´ë²¤íŠ¸ ìƒì„¸ | Persome</title>
  <link rel="stylesheet" href="/css/header.css">
  <style>
    .event-detail-main {
      max-width: 900px;
      margin: 0 auto;
      padding: 32px 20px 72px;
      font-family: "Noto Sans KR", Arial, sans-serif;
    }

    .event-title {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .event-date {
      font-size: 14px;
      color: #888;
      margin-bottom: 20px;
    }

    .event-banner-slider img {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .event-desc {
      font-size: 16px;
      color: #444;
      line-height: 1.6;
      margin-bottom: 32px;
    }

    .promo-section, .coupon-section { margin-bottom: 32px; }
    .promo-section h3, .coupon-section h3 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    /* í”„ë¡œëª¨ì…˜ + ë¸Œëœë“œ ìƒí’ˆ */
    .promo-block{margin-bottom:28px}
    .promo-item-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      border:1px solid #eee;
      border-radius:8px;
      padding:14px;
      margin-bottom:12px;
      background:#fafafa;
      font-size:15px
    }
    .brand-product-list{display:grid;grid-template-columns:repeat(4,minmax(200px,1fr));gap:20px;margin-top:12px}
    .product-card{border:1px solid #eee;border-radius:12px;background:#fff;text-align:center;padding:14px;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
    .product-card img{width:100%;height:200px;object-fit:cover;border-radius:8px}
    .product-card .name{margin:8px 0;font-size:15px;font-weight:600;color:#333}
    .product-card .brand{font-size:13px;color:#777;margin-bottom:6px}
    .product-card .price{font-size:14px}
    .product-card .price .sale{color:#A68DC0;font-weight:700;margin-right:4px}
    .product-card .price del{color:#aaa;font-size:13px}
    .product-card a { text-decoration: none; color: inherit; }
    .product-card a:hover { text-decoration: none; }


    /* âœ… ì¿ í° ì¹´ë“œ í‹°ì¼“ ìŠ¤íƒ€ì¼ */
    .coupon-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }

    .coupon-card {
      position: relative;
      border: 2px solid #A68DC0;
      border-radius: 12px;
      background: #fff;
      padding: 20px;
      text-align: center;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      flex: 0 0 280px;
    }

    /* ì–‘ìª½ êµ¬ë© */
    .coupon-card::before,
    .coupon-card::after {
      content: "";
      position: absolute;
      top: 50%;
      width: 24px;
      height: 24px;
      background: #f9f9f9; /* ë¶€ëª¨ ë°°ê²½ìƒ‰ê³¼ ê°™ê²Œ */
      border: 2px solid #A68DC0;
      border-radius: 50%;
      transform: translateY(-50%);
      z-index: 1;
    }
    .coupon-card::before { left: -13px; }
    .coupon-card::after { right: -13px; }

    .coupon-label {
      font-size: 18px;
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }

    .coupon-value {
      font-size: 32px;
      font-weight: 800;
      color: #A68DC0;
      margin: 12px 0;
    }

    .coupon-condition {
      font-size: 13px;
      color: #666;
      margin-bottom: 12px;
    }

    .coupon-btn {
      display: block;
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }
    .coupon-btn.download {
      background: #A68DC0;
      color: #fff;
    }
    .coupon-btn.expired {
      background: #eee;
      color: #999;
      cursor: not-allowed;
    }


    /* âœ… ìƒíƒœ ë°°ì§€ ìŠ¤íƒ€ì¼ */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      color: #fff;
    }
    .status-badge.active { background-color: #28a745; }
    .status-badge.scheduled { background-color: #ffc107; color: #222; }
    .status-badge.ended { background-color: #dc3545; }
    .brand-more-btn {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 8px;
      background: #A68DC0;
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      text-decoration: none;
      transition: background 0.2s;
    }
    .brand-more-btn:hover {
      background: #8c74aa;
    }
  </style>
</head>
<body>
<div id="header"></div>
<main class="event-detail-main">
  <h1 class="event-title">
    <span id="eventTitle"></span>
    <span id="eventStatus" class="status-badge"></span>
  </h1>

  <p class="event-date" id="eventDate"></p>
  <div class="event-banner-slider" id="eventImages"></div>
  <p class="event-desc" id="eventDesc"></p>

  <section class="promo-section">
    <h3>í”„ë¡œëª¨ì…˜</h3>
    <div id="promoContainer"></div>
  </section>

  <section class="coupon-section">
    <h3>ì¿ í°</h3>
    <div class="coupon-grid" id="couponList"></div>
  </section>
</main>

<script src="/js/header.js"></script>
<script>
  function extractPrice(prices) {
    if (!prices || prices.length === 0) return { original: null, sale: null };
    let original = prices.find(p => p.type === "ORIGINAL")?.price || null;
    let sale = prices.find(p => p.type === "SALE")?.price || null;
    return { original, sale: sale || original };
  }

  function mapEventStatus(status) {
    switch (status) {
      case "ACTIVE": return { text: "ì§„í–‰ ì¤‘", className: "active" };
      case "SCHEDULED": return { text: "ì˜ˆì •", className: "scheduled" };
      case "ENDED": return { text: "ì¢…ë£Œ", className: "ended" };
      default: return { text: "ì¢…ë£Œ", className: "ended" };
    }
  }
  function mapPromotionStatus(status) {
    switch (status) {
      case "ACTIVE": return "ì§„í–‰ ì¤‘";
      case "SCHEDULED": return "ì˜ˆì •";
      case "ENDED": return "ì¢…ë£Œ";
      default: return "ì¢…ë£Œ";
    }
  }
  function formatDiscount(type, value) {
    if (type === "RATE") {
      return (value * 100).toFixed(0) + "%"; // ì •ìˆ˜ë¡œ ë°˜ì˜¬ë¦¼
    } else {
      return value.toLocaleString() + "ì›";
    }
  }

  // âœ… ì•ˆì „í•œ fetch JSON í•¨ìˆ˜
  async function safeFetchJson(url) {
    try {
      const res = await fetch(url);
      if (!res.ok) {
        console.error("API ì—ëŸ¬:", res.status, await res.text());
        return null;
      }
      return await res.json();
    } catch (e) {
      console.error("ì‘ë‹µ JSON íŒŒì‹± ì‹¤íŒ¨:", e);
      return null;
    }
  }

  async function loadEventDetail() {
    try {
      const params = new URLSearchParams(window.location.search);
      const eventId = params.get("id");
      if (!eventId) return;

      const res = await fetch(`/api/events/${eventId}/details`);
      if (!res.ok) throw new Error("ì´ë²¤íŠ¸ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨");
      const { data } = await res.json();

      document.getElementById("eventTitle").textContent = data.name;
      const statusInfo = mapEventStatus(data.status);
      const statusEl = document.getElementById("eventStatus");
      statusEl.textContent = statusInfo.text;
      statusEl.className = `status-badge ${statusInfo.className}`;
      document.getElementById("eventDate").textContent =
              data.startDate.split("T")[0] + " ~ " + data.endDate.split("T")[0];
      document.getElementById("eventDesc").textContent = data.description;

      const imgContainer = document.getElementById("eventImages");
      imgContainer.innerHTML = (data.images?.length > 0)
              ? data.images.map(url => `<img src="${url}" alt="${data.name}">`).join("")
              : "";

      renderPromotionsWithProducts(data.promotions);

      const couponList = document.getElementById("couponList");
      couponList.innerHTML = (data.coupons?.length > 0)
              ? data.coupons.map(c => {
                const isActive = c.status === "ACTIVE";
                return `
            <div class="coupon-card ${isActive ? "" : "expired"}">
              <div class="coupon-label">${c.name}</div>
              <div class="coupon-value">${formatDiscount(c.discountType, c.discountValue)}</div>
              <div class="coupon-condition">${c.minOrderPrice}ì› ì´ìƒ ì ìš© ê°€ëŠ¥</div>
              <button class="coupon-btn ${isActive ? "download" : "expired"}" ${isActive ? "" : "disabled"}>
                ${isActive ? "ì¿ í° ë‹¤ìš´ë¡œë“œ" : "ê¸°ê°„ ë§Œë£Œ"}
              </button>
            </div>`;
              }).join("")
              : `<p>ë°œê¸‰ ê°€ëŠ¥í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
    } catch (e) {
      console.error(e);
    }
  }

  // ğŸ‘‰ ê³µí†µ: ìƒí’ˆ ì¹´ë“œ HTML ìƒì„± í•¨ìˆ˜
  function renderProductCard(product) {
    const { original, sale } = extractPrice(product.price);
    const imgUrl = product.imgs?.length > 0 ? product.imgs[0].imgUrl : "/images/no-image.png";

    return `
    <div class="product-card">
        <a href="/products/${product.product_id}">
            <img src="${imgUrl}" alt="${product.name}" />
        </a>
        <div class="name">${product.name}</div>
        <div class="brand">${product.brandName ?? ""}</div>
        <div class="price">
            <span class="sale">${sale ? sale.toLocaleString() : "-"}ì›</span>
            ${original && original !== sale ? `<del>${original.toLocaleString()}ì›</del>` : ""}
        </div>
    </div>`;
  }

  // ğŸ‘‰ í”„ë¡œëª¨ì…˜ + ìƒí’ˆ ë¬¶ìŒ ë Œë”ë§
  async function renderPromotionsWithProducts(promotions) {
    const container = document.getElementById("promoContainer");
    if (!promotions || promotions.length === 0) {
      container.innerHTML = "<p>ì ìš© ê°€ëŠ¥í•œ í”„ë¡œëª¨ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
      return;
    }

    for (const p of promotions) {
      const discountText = formatDiscount(p.discountType, p.discountValue);

      const promoBlock = document.createElement("div");
      promoBlock.className = "promo-block";

      const header = document.createElement("div");
      header.className = "promo-item-header";
      header.innerHTML = `<span>[${p.targets[0].targetType}] ${p.targets[0].targetName} ${discountText} í• ì¸ (${mapPromotionStatus(p.status)})</span>`;

      // ğŸ‘‰ ë”ë³´ê¸° ë²„íŠ¼
      if (p.targets[0].targetType === "BRAND") {
        const moreBtn = document.createElement("a");
        moreBtn.href = `/products/search?name=${encodeURIComponent(p.targets[0].targetName)}`;
        moreBtn.textContent = "ë”ë³´ê¸°";
        moreBtn.className = "brand-more-btn";
        header.appendChild(moreBtn);
      } else if (p.targets[0].targetType === "CATEGORY") {
        const moreBtn = document.createElement("a");
        moreBtn.href = `/categories/products?firstCategory=${encodeURIComponent(p.targets[0].firstCategory || "")}&secondCategory=${encodeURIComponent(p.targets[0].secondCategory || "none")}&thirdCategory=${encodeURIComponent(p.targets[0].thirdCategory || "none")}`;
        moreBtn.textContent = "ë”ë³´ê¸°";
        moreBtn.className = "brand-more-btn";
        header.appendChild(moreBtn);
      }

      promoBlock.appendChild(header);

      // ğŸ‘‰ ë¸Œëœë“œ/ì¹´í…Œê³ ë¦¬ ìƒí’ˆ ì¡°íšŒ
      for (const target of p.targets) {
        try {
          let url;
          if (target.targetType === "BRAND") {
            url = `/api/products/brand?name=${encodeURIComponent(target.targetName)}`;
          } else if (target.targetType === "CATEGORY") {
            url = `/api/categories/products?firstCategory=${encodeURIComponent(target.firstCategory)}&secondCategory=${encodeURIComponent(target.secondCategory || "none")}&thirdCategory=${encodeURIComponent(target.thirdCategory || "none")}`;
          } else {
            continue;
          }

          const res = await fetch(url);
          if (!res.ok) throw new Error("ìƒí’ˆ ì¡°íšŒ ì‹¤íŒ¨");
          const result = await res.json();
          const products = result.products || [];
          if (products.length === 0) continue;

          const shuffled = products.sort(() => 0.5 - Math.random());
          const selected = shuffled.slice(0, 4);

          const productList = document.createElement("div");
          productList.className = "brand-product-list";
          productList.innerHTML = selected.map(renderProductCard).join("");

          promoBlock.appendChild(productList);
        } catch (err) {
          console.error(err);
        }
      }

      container.appendChild(promoBlock);
    }
  }

  document.addEventListener("DOMContentLoaded", loadEventDetail);
</script>
</body>
</html>
