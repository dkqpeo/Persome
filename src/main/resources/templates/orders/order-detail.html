<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>주문 상세 | Persome</title>
    <style>
        body{font-family:"Noto Sans KR",Arial,sans-serif;margin:0;background:#fff;color:#333}
        .container{max-width:1100px;margin:20px auto;padding:0 16px}
        .grid{display:grid;grid-template-columns:260px 1fr;gap:24px;margin-top:18px}
        .card{border:1px solid #eee;border-radius:12px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.04)}
        .card .hd{padding:14px 16px;border-bottom:1px solid #f0f0f0;font-weight:700}
        .card .bd{padding:16px}
        .menu li a{display:block;padding:12px 14px;text-decoration:none;color:#333;border-radius:8px;font-size:15px;font-weight:500;transition:.2s}
        .menu li a:hover{background:#F6F3FF;color:#A68DC0;font-weight:600}
        .card .hd a{font-size:18px;font-weight:700;text-decoration:none;color:#222}
        .card .hd a:hover{color:#A68DC0}
        .order-container{padding:20px}
        .order-container h2{font-size:16px;margin:16px 0 10px;color:#A68DC0;border-bottom:1px solid #f0f0f0;padding-bottom:6px;font-weight:700}
        table{width:100%;border-collapse:collapse;margin-bottom:24px}
        th,td{border:1px solid #ddd;padding:12px;text-align:left;font-size:14px}
        th{background:#fafafa;width:180px}
        .highlight{color:#e60023;font-weight:700}
        .product-img{max-width:80px;max-height:80px;border-radius:6px;object-fit:cover}
        .btn-area{text-align:center;margin-top:20px}
        .btn-area a{display:inline-block;padding:10px 20px;margin:0 6px;background:#A68DC0;color:#fff;text-decoration:none;border-radius:6px;font-weight:600;font-size:14px}
        .btn-area a:hover{background:#8c75a6}
        .review-btn{display:inline-block;padding:6px 12px;background:#A68DC0;color:#fff;text-decoration:none;border-radius:4px;font-weight:500;font-size:12px;border:none;cursor:pointer}
        .review-btn:hover{background:#8c75a6}
        .review-btn:disabled{background:#ccc;cursor:not-allowed}
        .review-view-btn{background:#28a745;margin-right:4px}
        .review-view-btn:hover{background:#218838}
        .review-edit-btn{background:#ffc107;color:#212529;margin-right:4px}
        .review-edit-btn:hover{background:#e0a800}
        .review-delete-btn{background:#dc3545;color:#fff}
        .review-delete-btn:hover{background:#c82333}
        .payment-table th,.payment-table td{border:none;padding:8px 12px;text-align:left;font-size:14px}
        .payment-table th{font-weight:normal;color:#555;width:200px}
        .payment-table td{text-align:right;font-weight:600}
        .payment-table .discount{color:#e60023;font-weight:normal}
        .payment-table .highlight{color:#e60023;font-weight:700;font-size:1.2em}
        .payment-table .total-label{font-weight:700;color:#000}
        .payment-table .divider td{border-top:1px dashed #ddd;padding:6px 0}
        @media(max-width:768px){.grid{grid-template-columns:1fr}}
    </style>
    <link rel="stylesheet" href="/css/header.css">
</head>
<body>
<div id="header"></div>
<div id="siteHeader"></div>
<div class="container">
    <div id="hero"></div>
    <div id="kpi"></div>
    <div class="grid">
        <div id="sidebar"></div>
        <div class="card">
            <div class="hd">주문 상세 내역</div>
            <div class="bd order-container">
                <!-- 주문 정보 -->
                <h2>주문 정보</h2>
                <table>
                    <tr><th>주문 번호</th><td id="order-id"></td></tr>
                    <tr><th>주문일자</th><td id="order-date"></td></tr>
                    <tr><th>주문 상태</th><td id="order-status"></td></tr>
                </table>

                <!-- 배송 정보 -->
                <h2>배송지 정보</h2>
                <table>
                    <tr><th>받는 분</th><td id="receiver-name"></td></tr>
                    <tr><th>연락처</th><td id="receiver-phone"></td></tr>
                    <tr><th>도로명 주소</th><td id="road-addr"></td></tr>
                    <tr><th>지번 주소</th><td id="jibun-addr"></td></tr>
                    <tr><th>상세 주소</th><td id="detail-addr"></td></tr>
                    <tr><th>요청사항</th><td id="request-message"></td></tr>
                </table>

                <!-- 상품 목록 -->
                <h2>주문 상품</h2>
                <table>
                    <thead>
                    <tr>
                        <th>상품 이미지</th>
                        <th>상품명</th>
                        <th>단가</th>
                        <th>수량</th>
                        <th>총액</th>
                        <th>리뷰</th>
                    </tr>
                    </thead>
                    <tbody id="order-items"></tbody>
                </table>

                <!-- 결제 정보 -->
                <h2>결제 정보</h2>
                <table class="payment-table">
                    <tr><th>총 상품금액</th><td id="original-price"></td></tr>
                    <tr><th>총 배송비</th><td id="delivery-fee"></td></tr>
                    <tr class="divider"><td colspan="2"></td></tr>
                    <tr><th>쿠폰 할인</th><td id="coupon-discount" class="discount"></td></tr>
                    <tr><th>포인트 사용</th><td id="point-used" class="discount"></td></tr>
                    <tr class="divider"><td colspan="2"></td></tr>
                    <tr><th class="total-label">총 결제금액</th><td id="payment-amount" class="highlight"></td></tr>
                    <tr><th>결제 수단</th><td id="payment-method"></td></tr>
                    <tr><th>결제 상태</th><td id="payment-status"></td></tr>
                    <tr><th>결제일</th><td id="paid-at"></td></tr>
                </table>

                <div class="btn-area">
                    <a href="/">홈으로</a>
                    <a href="/mypage/orders">주문 내역</a>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="/js/header.js"></script>
<script src="/js/fragment-loader.js"></script>
<script src="/js/mypage/mypage.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get("orderId");
        if (!orderId){alert("잘못된 접근입니다.");location.href="/";return;}
        try{
            const res=await fetch(`/api/orders/${orderId}`);
            if(!res.ok)throw new Error("주문 정보를 불러올 수 없습니다.");
            const {data}=await res.json();
            document.getElementById("order-id").textContent=data.orderId;
            document.getElementById("order-date").textContent=new Date(data.orderDate).toLocaleString();
            document.getElementById("order-status").textContent=data.orderStatus;
            if(data.deliveryInfo){
                document.getElementById("receiver-name").textContent=data.deliveryInfo.receiverName;
                document.getElementById("receiver-phone").textContent=data.deliveryInfo.receiverPhone;
                document.getElementById("road-addr").textContent=data.deliveryInfo.roadAddr;
                document.getElementById("jibun-addr").textContent=data.deliveryInfo.jibunAddr;
                document.getElementById("detail-addr").textContent=data.deliveryInfo.addressDetail;
            }
            document.getElementById("request-message").textContent=data.requestMessage||"-";
            const tbody=document.getElementById("order-items");
            tbody.innerHTML=data.items.map(item=>{
                return `
                    <tr>
                        <td><img src="${item.imageUrl||'/images/no-image.png'}" class="product-img"></td>
                        <td>${item.productName}</td>
                        <td>${Number(item.unitPrice).toLocaleString()}원</td>
                        <td>${item.quantity}</td>
                        <td class="highlight">${Number(item.totalPrice).toLocaleString()}원</td>
                        <td id="review-cell-${item.orderItemId}">-</td>
                    </tr>`;
            }).join("");
            
            // 주문 상태가 "주문완료"일 때만 리뷰 버튼 관련 처리
            if (data.orderStatus === "배송완료") {
                loadReviewStatusForItems(data.items);
            }
            document.getElementById("original-price").textContent=(data.originalPrice?Number(data.originalPrice).toLocaleString():"0")+"원";
            document.getElementById("delivery-fee").textContent=(data.shippingFee?Number(data.shippingFee).toLocaleString():"0")+"원";
            document.getElementById("coupon-discount").textContent=data.couponDiscountAmount?"-"+Number(data.couponDiscountAmount).toLocaleString()+"원":"- 0원";
            document.getElementById("point-used").textContent=data.pointUsedAmount?"-"+Number(data.pointUsedAmount).toLocaleString()+"원":"- 0원";
            if(data.payment){
                document.getElementById("payment-amount").textContent=Number(data.payment.amount).toLocaleString()+"원";
                document.getElementById("payment-method").textContent=data.payment.method;
                document.getElementById("payment-status").textContent=data.payment.status;
                document.getElementById("paid-at").textContent=new Date(data.payment.paidAt).toLocaleString();
            }
        }catch(e){alert(e.message);location.href="/";}
    });
    
    // 각 주문 아이템에 대한 리뷰 상태 로드
    async function loadReviewStatusForItems(items) {
        for (const item of items) {
            try {
                const response = await fetch(`/reviews/order-item/${item.orderItemId}/status`);
                if (response.ok) {
                    const result = await response.json();
                    const reviewStatus = result.data;
                    updateReviewButton(item.orderItemId, reviewStatus);
                } else {
                    // API 오류 시 기본 리뷰 작성 버튼 표시
                    updateReviewButton(item.orderItemId, { hasReview: false, reviewId: null });
                }
            } catch (error) {
                console.error(`리뷰 상태 로드 실패 (OrderItemId: ${item.orderItemId}):`, error);
                // 오류 시 기본 리뷰 작성 버튼 표시
                updateReviewButton(item.orderItemId, { hasReview: false, reviewId: null });
            }
        }
    }
    
    // 리뷰 버튼 업데이트
    function updateReviewButton(orderItemId, reviewStatus) {
        const cellId = `review-cell-${orderItemId}`;
        const cell = document.getElementById(cellId);
        
        if (!cell) return;
        
        if (reviewStatus.hasReview) {
            // 이미 리뷰가 있는 경우: 리뷰 보기, 리뷰 수정, 리뷰 삭제 버튼
            cell.innerHTML = `
                <button class="review-btn review-view-btn" onclick="viewReview(${reviewStatus.reviewId})">리뷰 보기</button>
                <button class="review-btn review-edit-btn" onclick="editReview(${reviewStatus.reviewId})">리뷰 수정</button>
                <button class="review-btn review-delete-btn" onclick="deleteReview(${reviewStatus.reviewId}, ${orderItemId})">리뷰 삭제</button>
            `;
        } else {
            // 리뷰가 없는 경우: 리뷰 작성 버튼
            cell.innerHTML = `<button class="review-btn" onclick="openReviewModal(${orderItemId})">리뷰 작성</button>`;
        }
    }

    // 리뷰 작성 모달 팝업 열기 함수
    function openReviewModal(orderItemId) {
        // 팝업창으로 리뷰 작성 모달 열기
        const popup = window.open(
            `/reviews/modal?orderItemId=${orderItemId}`,
            'reviewModal',
            'width=550,height=700,scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no,status=no'
        );
        
        // 팝업이 닫힐 때 리뷰 상태 업데이트
        const checkClosed = setInterval(() => {
            if (popup.closed) {
                clearInterval(checkClosed);
                // 리뷰 작성 완료 후 해당 아이템의 리뷰 상태 다시 로드
                reloadReviewStatus(orderItemId);
            }
        }, 1000);
    }
    
    // 특정 주문 아이템의 리뷰 상태 다시 로드
    async function reloadReviewStatus(orderItemId) {
        try {
            const response = await fetch(`/reviews/order-item/${orderItemId}/status`);
            if (response.ok) {
                const result = await response.json();
                const reviewStatus = result.data;
                updateReviewButton(orderItemId, reviewStatus);
            }
        } catch (error) {
            console.error('리뷰 상태 업데이트 실패:', error);
        }
    }
    
    // 리뷰 보기
    function viewReview(reviewId) {
        // 팝업창으로 리뷰 보기 모달 열기
        const popup = window.open(
            `/reviews/view-modal?reviewId=${reviewId}`,
            'reviewViewModal',
            'width=550,height=700,scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no,status=no'
        );
        
        if (!popup) {
            alert('팝업이 차단되어 있습니다. 팝업 차단을 해제해 주세요.');
        }
    }
    
    // 리뷰 수정
    function editReview(reviewId) {
        // 팝업창으로 리뷰 수정 모달 열기
        const popup = window.open(
            `/reviews/edit-modal?reviewId=${reviewId}`,
            'reviewEditModal',
            'width=550,height=700,scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no,status=no'
        );
        
        if (!popup) {
            alert('팝업이 차단되어 있습니다. 팝업 차단을 해제해 주세요.');
            return;
        }
        
        // 팝업이 닫힐 때 리뷰 상태 업데이트
        const checkClosed = setInterval(() => {
            if (popup.closed) {
                clearInterval(checkClosed);
                // 리뷰 수정 완료 후 해당 아이템의 리뷰 상태 다시 로드
                // reviewId를 통해 orderItemId를 찾아야 하므로 전체 페이지를 새로고침
                location.reload();
            }
        }, 1000);
    }
    
    // 리뷰 삭제
    async function deleteReview(reviewId, orderItemId) {
        if (!confirm('정말로 리뷰를 삭제하시겠습니까?\n삭제된 리뷰는 복구할 수 없습니다.')) {
            return;
        }
        
        try {
            const response = await fetch(`/reviews/${reviewId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                const result = await response.json();
                alert(result.message || '리뷰가 성공적으로 삭제되었습니다.');
                
                // 리뷰 삭제 후 버튼 상태 업데이트 (리뷰 작성 버튼으로 변경)
                updateReviewButton(orderItemId, { hasReview: false, reviewId: null });
            } else {
                const errorResult = await response.json();
                throw new Error(errorResult.message || '리뷰 삭제에 실패했습니다.');
            }
        } catch (error) {
            console.error('리뷰 삭제 오류:', error);
            alert(error.message || '리뷰 삭제 중 오류가 발생했습니다.');
        }
    }
</script>
</body>
</html>
