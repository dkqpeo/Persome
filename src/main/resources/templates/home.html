<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>홈 | Persome</title>
    <link rel="stylesheet" href="/css/header.css">
    <style>
        body, html {
            height: 100%;
            margin: 0;
        }

        body {
            font-family: "Noto Sans KR", Arial, sans-serif;
            margin: 0;
            background-color: #fff;
            color: #333;
        }

        .banner {
            width: 100%;
            padding: 0;
            background: none;
        }

        .banner-content {
            width: 100%;
            max-width: none;
            margin: 0;
        }

        .banner-inner {
            position: relative;
            width: 100%;
            height: clamp(220px, 30vw, 420px);
            min-height: 220px;
            overflow: hidden;
        }

        .section {
            width: 90%;
            max-width: 1200px;
            margin: 40px auto;
        }

        .event-carousel {
            position: relative;
            height: 100%;
            width: 100%;
        }

        .event-carousel__viewport {
            position: relative;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        .event-carousel__track {
            display: flex;
            height: 100%;
            margin: 0;
            padding: 0;
            list-style: none;
            scroll-snap-type: x mandatory;
        }

        .event-slide {
            position: relative;
            display: block;
            flex: 0 0 100%;
            height: 100%;
            scroll-snap-align: center;
            overflow: hidden;
        }

        .event-slide__image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .event-slide__overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding: clamp(24px, 6vw, 56px) clamp(28px, 8vw, 72px);
            background: linear-gradient(180deg, rgba(8, 6, 18, 0) 35%, rgba(8, 6, 18, 0.78) 100%);
            color: #fff;
            text-align: center;
            gap: clamp(8px, 1.6vw, 14px);
        }

        .event-slide__badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 18px;
            border-radius: 999px;
            font-size: 0.9em;
            font-weight: 600;
            color: #fff;
            background: rgba(255,255,255,0.35);
        }

        .event-slide__countdown {
            margin: 0;
            font-size: clamp(1em, 1.5vw, 1.2em);
            font-weight: 600;
            color: rgba(255,255,255,0.95);
            text-shadow: 0 10px 28px rgba(10, 8, 20, 0.55);
        }

        .event-slide__badge--scheduled { background: rgba(255,205,60,0.92); color: #4c3579; }
        .event-slide__badge--active { background: rgba(51,193,125,0.92); }
        .event-slide__badge--ended { background: rgba(198,76,91,0.92); }

        .event-slide__title {
            margin: 0;
            font-size: clamp(1.65em, 3vw, 2.2em);
            font-weight: 800;
            line-height: 1.15;
            letter-spacing: -0.02em;
            text-shadow: 0 12px 32px rgba(12, 8, 22, 0.6);
        }

        .event-slide__description {
            margin: 0;
            font-size: clamp(0.95em, 1.4vw, 1.15em);
            color: rgba(255,255,255,0.9);
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            max-width: min(720px, 78%);
        }

        .event-slide__date {
            margin: 0;
            font-size: 0.95em;
            font-weight: 500;
            letter-spacing: 0.04em;
            color: rgba(255,255,255,0.75);
        }

        .event-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(76, 53, 121, 0.92);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: background 0.2s ease;
            box-shadow: 0 4px 12px rgba(45, 22, 80, 0.25);
            z-index: 2;
        }

        .event-nav:hover {
            background: rgba(64, 41, 108, 0.95);
        }

        .event-nav:disabled {
            background: rgba(200, 190, 220, 0.6);
            cursor: default;
            box-shadow: none;
        }

        .event-nav--prev {
            left: 18px;
        }

        .event-nav--next {
            right: 18px;
        }

        .event-indicators {
            position: absolute;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 5;
        }

        .event-indicator {
            width: 38px;
            height: 6px;
            border-radius: 999px;
            border: none;
            background: rgba(255, 255, 255, 0.35);
            cursor: pointer;
            transition: background 0.3s ease, transform 0.3s ease;
        }

        .event-indicator.is-active {
            background: #fff;
            transform: scaleX(1.12);
        }

        .event-indicator:focus-visible {
            outline: 2px solid rgba(255, 255, 255, 0.8);
            outline-offset: 2px;
        }

        h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #4C3579;
        }

        .product-list {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .product {
            flex: 1 1 calc(25% - 20px);
            border: 1px solid #eee;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            padding: 10px;
            text-align: center;
            background: #fff;
        }

        .product img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
        }

        .product h3 {
            font-size: 1em;
            margin: 10px 0;
        }

        .product p {
            font-size: 0.9em;
            color: #666;
        }

        /* 개인화 추천 섹션 스타일 */
        .personalized-title {
            color: #4C3579;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .personalized-title::before {
            font-size: 1.2em;
        }

        .recommendation-reason {
            font-size: 0.85em;
            color: #7C4DFF;
            background: rgba(124, 77, 255, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 5px;
            display: inline-block;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4C3579;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>
<!-- 헤더 -->
<div id="header"></div>

<!-- 메인 배너 (이벤트 영역) -->
<div class="banner">
    <div class="banner-content">
        <div class="banner-inner">
            <div class="event-carousel">
                <button id="eventPrevBtn" class="event-nav event-nav--prev" type="button" aria-label="이전 이벤트" disabled>&lsaquo;</button>
                <div class="event-carousel__viewport">
                    <div id="homeEventTrack" class="event-carousel__track"></div>
                </div>
                <button id="eventNextBtn" class="event-nav event-nav--next" type="button" aria-label="다음 이벤트" disabled>&rsaquo;</button>
                <div id="eventIndicators" class="event-indicators" hidden></div>
            </div>
        </div>
    </div>
</div>

<!-- 개인화 추천 상품 (로그인 시에만 표시) -->
<div id="personalizedSection" class="section" style="display: none;">
    <h2 class="personalized-title">최근 구매내역 기반 추천 상품</h2>
    <p style="color: #666; margin-bottom: 20px;">고객님의 구매 패턴을 분석하여 맞춤 상품을 추천드립니다.</p>
    <div id="personalizedProducts" class="product-list">
        <div class="loading-spinner"></div>
        <span style="margin-left: 10px;">추천 상품을 불러오는 중...</span>
    </div>
</div>

<!-- 추천 상품 -->
<div class="section">
    <h2>요즘 주목 받는 상품</h2>
    <div id="popularProducts" class="product-list">
        <!-- AJAX로 불러올 상품 카드 -->
    </div>
</div>

<!-- 신규 상품 -->
<div class="section">
    <h2>신규 상품</h2>
    <div id="newProducts" class="product-list">
        <!-- AJAX로 불러올 상품 카드 -->
    </div>
</div>

<script src="/js/header.js"></script>
<script src="/js/app.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (window.Persome) {
            window.Persome.loadHomeEvents();
            window.Persome.loadHomeProducts();
            window.Persome.updateHeaderCartCount();
        }
        
        // 개인화 추천 로드
        loadPersonalizedRecommendations();
    });

    // 개인화 추천 상품 로드 함수
    async function loadPersonalizedRecommendations() {
        try {
            // 직접 로그인 상태 API 호출
            const userResponse = await fetch("/api/users/me", { credentials: "include" });
            
            if (!userResponse.ok) {
                // 로그인 상태가 아니면 섹션 숨김
                document.getElementById('personalizedSection').style.display = 'none';
                return;
            }
            
            // 로그인 상태라면 섹션 표시하고 추천 API 호출
            document.getElementById('personalizedSection').style.display = 'block';
            
            const response = await fetch('/api/recommendations/personalized?limit=8');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('추천 API 응답:', data); // 디버깅용 로그 추가
            
            // 다양한 응답 구조 처리
            let products = null;
            if (data.success && data.result) {
                products = data.result;
            } else if (data.data) {
                products = data.data;
            } else if (Array.isArray(data)) {
                products = data;
            }
            
            console.log('파싱된 products:', products); // 디버깅용 로그 추가
            
            if (products && products.length > 0) {
                displayPersonalizedProducts(products);
            } else {
                showNoRecommendationsMessage();
            }
            
        } catch (error) {
            console.error('개인화 추천 로드 실패:', error);
            // 로그인 상태가 아니거나 오류 발생 시 섹션 숨김
            document.getElementById('personalizedSection').style.display = 'none';
        }
    }

    // 개인화 추천 상품 표시 함수
    function displayPersonalizedProducts(products) {
        const container = document.getElementById('personalizedProducts');
        if (!container) {
            return;
        }
        
        if (!products || products.length === 0) {
            showNoRecommendationsMessage();
            return;
        }
        
        const productCards = products.map(product => {
            const productId = product.productId || '';
            const name = product.name || '상품명 없음';
            const brand = product.brand || '브랜드 없음';
            const price = product.price ? Number(product.price).toLocaleString() : '0';
            const imageUrl = product.imageUrl || '/images/no-image.jpg';
            const reason = product.recommendationReason || 'AI 추천';
            
            return `
                <div class="product" onclick="location.href='/products/${productId}'" style="cursor: pointer;">
                    <img src="${imageUrl}" alt="${name}" onerror="this.src='/images/no-image.jpg'">
                    <h3>${name}</h3>
                    <p><strong>${brand}</strong></p>
                    <p>${price}원</p>
                    <div class="recommendation-reason">${reason}</div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = productCards;
    }

    // 추천 상품이 없을 때 메시지 표시
    function showNoRecommendationsMessage() {
        const container = document.getElementById('personalizedProducts');
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <p>구매 내역을 바탕으로 상품을 추천해드릴 예정입니다.</p>
                <p>첫 구매 후 개인 맞춤 추천을 만나보세요!</p>
            </div>
        `;
    }
</script>
</body>

</html>
