<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입 | Persome</title>
    <link rel="stylesheet" href="/css/header.css">
    <style>
        body {
            font-family: "Noto Sans KR", Arial, sans-serif;
            margin: 0;
            background-color: #fff;
            color: #333;
        }

        .register-container {
            max-width: 500px;
            margin: 50px auto;
            padding: 40px;
            border: 1px solid #eee;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.05);
        }

        .register-container label {
            font-weight: bold;
            display: block;
            margin: 15px 0 5px;
        }

        .register-container .checkbox-group {
            display: flex;
            flex-direction: column; /* 세로 정렬 */
            gap: 8px;               /* 항목 간격 */
            margin-top: 5px;
        }

        .register-container .checkbox-group label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: normal;
            cursor: pointer;
            white-space: nowrap;      /* 텍스트 줄바꿈 방지 */
            width: fit-content;       /* label이 텍스트 길이만큼만 차지 */
        }

        h2 {
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 25px;
            color: #4C3579;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-row div {
            flex: 1;
        }

        button {
            padding: 14px;
            background-color: #4C3579;
            color: white;
            border: none;
            border-radius: 6px;
            margin-top: 20px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #3b2760;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* 회원가입 버튼만 꽉 차게 */
        #submitButton {
            width: 100%;
        }

        .extra-links {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9em;
        }

        .extra-links a {
            text-decoration: none;
            color: #4C3579;
        }

        /* 알림 메시지 스타일 */
        .alert {
            padding: 12px;
            margin: 15px 0;
            border-radius: 6px;
            display: none;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        /* 로딩 스피너 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4C3579;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-row2{
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .form-row2 input {
            flex: 1; /* ✅ input이 남은 공간을 꽉 채우도록 */
            padding: 0 12px;
            font-size: 1em;
            height: 46px;
            box-sizing: border-box;
        }

        .check-id-btn {
            background-color: #A68DC0; /* ✅ 시그니처 색상 */
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0 20px;
            height: 46px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: -2px;
        }

        .check-id-btn:hover {
            background-color: #3b2760;
        }
        /* 우편번호 + 버튼 간격 */
        .form-row {
            display: flex;
            gap: 10px;           /* input과 버튼 사이 여백 */
            margin-bottom: 15px; /* 줄 아래 여백 */
        }

        /* 우편번호 input */
        #zip {
            flex: 1;             /* 버튼 빼고 나머지 공간 꽉 채우기 */
        }

        /* 버튼 크기 맞추기 */
        .form-row button {
            height: 46px;        /* input 높이에 맞춤 */
            padding: 0 20px;
            border-radius: 6px;
            background-color: #A68DC0; /* 시그니처 컬러 */
            color: white;
            border: none;
            cursor: pointer;
        }

        /* 도로명/지번/상세 주소 input 줄마다 여백 */
        #roadAddr,
        #jibunAddr,
        #addrDetail {
            margin-bottom: 15px;
        }

    </style>
</head>
<body>
<!-- 헤더 -->
<div id="header"></div>

<!-- 회원가입 폼 -->
<div class="register-container">
    <h2>회원가입</h2>

    <!-- 알림 메시지 -->
    <div id="alertMessage" class="alert"></div>

    <form id="registerForm">
        <label>아이디</label>
        <div class="form-row2">
            <input type="text" id="loginId" name="loginId" placeholder="아이디" required>
            <button type="button" id="checkIdButton" class="check-id-btn">중복확인</button>
        </div>
        <div id="idCheckMessage" style="margin-top:5px; font-size:0.9em;"></div>

        <label>비밀번호</label>
        <input type="password" id="password" name="password" placeholder="비밀번호" required>
        <div class="error-message" id="passwordError"></div>

        <label>비밀번호 확인</label>
        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="비밀번호 확인" required>
        <div class="error-message" id="confirmPasswordError"></div>

        <label>이름</label>
        <input type="text" id="name" name="name" placeholder="이름" required>
        <div class="error-message" id="nameError"></div>

        <label>전화번호</label>
        <input type="text" id="phone" name="phone" placeholder="010-0000-0000" required>
        <div class="error-message" id="phoneError"></div>

        <label>이메일</label>
        <input type="email" id="email" name="email" placeholder="example@email.com" required>
        <div class="error-message" id="emailError"></div>

        <label>생년월일</label>
        <input type="date" id="birthDate" name="birthDate" required>
        <div class="error-message" id="birthDateError"></div>

        <label>성별</label>
        <select id="gender" name="gender" required>
            <option value="" disabled selected>선택</option>
            <option value="M">남성</option>
            <option value="F">여성</option>
        </select>
        <div class="error-message" id="genderError"></div>

        <label>주소</label>
        <div class="form-row">
            <input type="text" id="zip" name="zip" placeholder="우편번호" required style="flex:1;">
            <button type="button" class="check-id-btn" onclick="openDaumPostcode()">우편번호 찾기</button>
        </div>

        <input type="text" id="roadAddr" name="roadAddr" placeholder="도로명 주소" required>
        <div class="error-message" id="roadAddrError"></div>

        <input type="text" id="jibunAddr" name="jibunAddr" placeholder="지번 주소" required>
        <div class="error-message" id="jibunAddrError"></div>


        <input type="text" id="addrDetail" name="addrDetail" placeholder="상세 주소" required>
        <div class="error-message" id="addrDetailError"></div>

        <label>알림 설정</label>
        <div class="checkbox-group">
            <label><input type="checkbox" id="emailEnabled" name="emailEnabled"> 이메일 수신 동의</label>
            <label><input type="checkbox" id="smsEnabled" name="smsEnabled"> 문자 수신 동의</label>
            <label><input type="checkbox" id="pushEnabled" name="pushEnabled"> 푸시 알림 동의</label>
        </div>

        <!-- 약관 동의 hidden 필드 -->
        <input type="hidden" id="consentsData" name="consents">

        <button type="submit" id="submitButton">회원가입</button>
    </form>

    <div class="extra-links">
        <a href="/users/login">이미 계정이 있으신가요? 로그인</a>
    </div>
</div>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="/js/header.js"></script>
<script>
    function openDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                const roadAddr = data.roadAddress;
                const jibunAddr = data.jibunAddress;
                let extraRoadAddr = '';

                if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
                    extraRoadAddr += data.bname;
                }
                if (data.buildingName !== '' && data.apartment === 'Y') {
                    extraRoadAddr += (extraRoadAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                }
                if (extraRoadAddr !== '') {
                    extraRoadAddr = ' (' + extraRoadAddr + ')';
                }

                document.getElementById('zip').value = data.zonecode;
                document.getElementById('roadAddr').value = roadAddr;
                document.getElementById('jibunAddr').value = jibunAddr;
            }
        }).open();
    }
    // 약관 동의값 불러와 hidden input에 넣기
    document.addEventListener("DOMContentLoaded", () => {
        const consents = sessionStorage.getItem("consents");
        if (consents) {
            document.getElementById("consentsData").value = consents;
        }
    });

    let isIdChecked = false; // ✅ 아이디 중복확인 여부 저장

    // 아이디 중복 확인
    document.getElementById("checkIdButton").addEventListener("click", async () => {
        const loginId = document.getElementById("loginId").value.trim();
        const messageBox = document.getElementById("idCheckMessage");

        if (!loginId) {
            messageBox.textContent = "아이디를 입력해주세요.";
            messageBox.style.color = "red";
            isIdChecked = false;
            return;
        }

        try {
            const response = await fetch(`/api/users/check-id?loginId=${loginId}`);
            const result = await response.json();
            if (response.ok) {
                messageBox.textContent = result.message;
                messageBox.style.color = "green";
                isIdChecked = true;
            } else {
                messageBox.textContent = result.message; // "이미 가입된 회원입니다."
                messageBox.style.color = "red";
                isIdChecked = false;
            }
        } catch {
            messageBox.textContent = "서버 오류가 발생했습니다.";
            messageBox.style.color = "red";
            isIdChecked = false;
        }
    });

    document.getElementById('registerForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // 기존 에러 메시지 초기화
        clearErrors();

        if (!isIdChecked) {  // ✅ 중복확인 안 했으면 막기
            alert("아이디 중복확인은 필수입니다.");
            return;
        }

        // 폼 데이터 수집
        const formData = new FormData(this);
        const data = {};

        // 체크박스 처리
        data.emailEnabled = document.getElementById('emailEnabled').checked;
        data.smsEnabled = document.getElementById('smsEnabled').checked;
        data.pushEnabled = document.getElementById('pushEnabled').checked;
        data.consents = JSON.parse(document.getElementById('consentsData').value || "[]");

        // 일반 필드 처리
        formData.forEach((value, key) => {
            if (!['emailEnabled','smsEnabled','pushEnabled','consents'].includes(key)) {
                data[key] = value;
            }
        });

        // 버튼 비활성화 및 로딩 표시
        const submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="loading"></span>처리 중...';

        // AJAX 요청
        fetch('/api/users/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(async response => {
                if (response.ok) {
                    return response.text(); // 성공은 단순 문자열
                } else {
                    // ❌ 실패 시 JSON 응답을 파싱해서 message만 꺼냄
                    const error = await response.json().catch(() => null);
                    const msg = error && error.message ? error.message : '회원가입 중 오류가 발생했습니다.';
                    throw new Error(msg);
                }
            })
            .then(data => {
                alert('회원가입이 완료되었습니다!');

                // 폼 초기화
                document.getElementById('registerForm').reset();

                window.location.href = '/users/login';
            })
            .catch(error => {
                // 여기서 에러는 항상 Error(message) 형태라 message만 출력됨
                alert(error.message);
            })
            .finally(() => {
                // 버튼 복구
                submitButton.disabled = false;
                submitButton.innerHTML = '회원가입';
            });
    });

    // 에러 메시지 초기화
    function clearErrors() {
        const errorElements = document.querySelectorAll('.error-message');
        const inputElements = document.querySelectorAll('input, select');

        errorElements.forEach(element => {
            element.style.display = 'none';
            element.textContent = '';
        });

        inputElements.forEach(element => {
            element.classList.remove('error-field');
        });
    }

    // Validation 에러 처리
    function handleValidationErrors(errors) {
        if (errors.fieldErrors) {
            errors.fieldErrors.forEach(error => {
                const field = error.field;
                const message = error.defaultMessage;

                const inputElement = document.getElementById(field);
                const errorElement = document.getElementById(field + 'Error');

                if (inputElement && errorElement) {
                    inputElement.classList.add('error-field');
                    errorElement.textContent = message;
                    errorElement.style.display = 'block';
                }
            });
        }
    }

    // 비밀번호 확인 실시간 검증
    document.getElementById('confirmPassword').addEventListener('input', function() {
        const password = document.getElementById('password').value;
        const confirmPassword = this.value;
        const errorElement = document.getElementById('confirmPasswordError');

        if (confirmPassword && password !== confirmPassword) {
            this.classList.add('error-field');
            errorElement.textContent = '비밀번호가 일치하지 않습니다.';
            errorElement.style.display = 'block';
        } else {
            this.classList.remove('error-field');
            errorElement.style.display = 'none';
        }
    });

    // 전화번호 포맷팅
    document.getElementById('phone').addEventListener('input', function() {
        let value = this.value.replace(/[^0-9]/g, '');
        if (value.length > 3 && value.length <= 7) {
            value = value.replace(/(\d{3})(\d+)/, '$1-$2');
        } else if (value.length > 7) {
            value = value.replace(/(\d{3})(\d{4})(\d+)/, '$1-$2-$3');
        }
        this.value = value;
    });
</script>

</body>
</html>