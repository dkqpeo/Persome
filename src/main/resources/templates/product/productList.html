<!DOCTYPE html>
<html>
<head>
    <title>상품 목록</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/header.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif; }
        .container { max-width: 1180px; margin: 0 auto; padding: 20px; }
        .breadcrumbs { color:#888; font-size: 14px; margin: 10px 0 20px; }
        .page-title { font-size: 28px; font-weight: 700; margin: 10px 0 20px; }
        .toolbar { display:flex; justify-content: space-between; align-items:center; border-top:1px solid #eee; border-bottom:1px solid #eee; padding:10px 0; margin-bottom: 20px; }
        .tabs { display:flex; gap:16px; }
        .tabs button { background:#fff; border:none; cursor:pointer; padding:6px 4px; font-size:14px; color:#666; }
        .tabs button.active { color:#111; font-weight:600; border-bottom: 2px solid #111; }
        .view-size { display:flex; gap:8px; align-items:center; color:#666; }
        .view-size button { border:1px solid #ddd; background:#fff; padding:4px 8px; cursor:pointer; }
        .view-size button.active { border-color:#111; color:#111; font-weight:600; }
        .grid { display:grid; grid-template-columns: repeat(4, 1fr); gap: 24px; }
        .card { border:1px solid #eee; border-radius:8px; padding:12px; background:#fff; }
        .thumb { width:100%; border-radius:6px; }
        .brand { font-size:12px; color:#777; margin:8px 0 2px; text-decoration: none; display: block; }
        .brand:hover { color:#555; }
        .name { font-size:14px; height:40px; overflow:hidden; margin:0 0 6px; text-decoration: none; color: #333; display: block; }
        .name:hover { color:#111; }
        .price-area { display:flex; gap:8px; align-items:center; margin-top:4px; }
        .price { color:#d60000; font-weight:700; }
        .original { color:#888; text-decoration: line-through; font-size:12px; }
        .badges { margin-top:6px; display:flex; gap:4px; flex-wrap:wrap; }
        .badge { font-size:11px; border:1px solid #eee; padding:2px 4px; border-radius:3px; color:#555; }
        .actions { display:flex; gap:6px; margin-top:10px; }
        .btn { flex:1; background:#f5f5f5; border:1px solid #eee; padding:8px; cursor:pointer; }
        .btn.primary { background:#ff5b5b; color:#fff; border:1px solid #ff5b5b; }
        .pagination { display:flex; justify-content:center; gap:8px; margin:28px 0; }
        .pagination button { border:1px solid #ddd; background:#fff; padding:6px 10px; cursor:pointer; }
        .pagination button.active { background:#111; color:#fff; border-color:#111; }
        .result-count { color:#666; margin: 14px 0; }
        .category-filter { margin: 20px 0; padding: 0; background: #f8f8f8; border-radius: 4px; }
        .category-filter-inner { padding: 15px; }
        .filter-label { font-size: 14px; color: #333; margin-bottom: 10px; font-weight: 500; }
        .filter-tabs { display: flex; gap: 0; }
        .filter-tabs button { background: #fff; border: 1px solid #ddd; color: #666; padding: 8px 16px; cursor: pointer; font-size: 13px; border-right: 0; }
        .filter-tabs button:first-child { border-radius: 4px 0 0 4px; }
        .filter-tabs button:last-child { border-radius: 0 4px 4px 0; border-right: 1px solid #ddd; }
        .filter-tabs button.active { background: #4CAF50; color: #fff; border-color: #4CAF50; }
    </style>
</head>
<body>
<div id="header"></div>
<div class="container">

    <!-- 초기 파라미터를 data-* 로 주입 -->
    <div id="page-data"
         data-first=""
         data-second=""
         data-third=""
         data-page="0"
         data-size="24">
    </div>

    <!-- 상단 네비/타이틀 -->
    <div class="breadcrumbs">스킨케어 > 스킨/토너</div>
    <h1 class="page-title">카테고리명</h1>

    <!-- 3차 카테고리 필터 영역 -->
    <div class="category-filter" id="category-filter">
        <div class="category-filter-inner">
            <div class="filter-tabs" id="category-tabs">
                <button data-category="all" class="active">전체</button>
            </div>
        </div>
    </div>

    <!-- 툴바: 정렬/VIEW -->
    <div class="toolbar">
        <div class="tabs" id="sort-tabs">
            <button data-sort="POPULAR" class="active">인기순</button>
            <button data-sort="NEW">신상품순</button>
            <button data-sort="SALES">판매순</button>
            <button data-sort="LOW_PRICE">낮은 가격순</button>
            <button data-sort="HIGH_PRICE">높은 가격순</button>
            <button data-sort="DISCOUNT">할인율순</button>
        </div>
        <div class="view-size">
            <span>VIEW</span>
            <button data-size="24" class="active">24</button>
            <button data-size="36">36</button>
        </div>
    </div>

    <div class="result-count" id="result-count"></div>

    <!-- 상품 그리드 -->
    <div class="grid" id="product-grid"></div>

    <!-- 페이지네이션 -->
    <div class="pagination" id="pagination"></div>
</div>
<script src="/js/header.js"></script>
<script>
    (function() {
        // URL 파라미터에서 카테고리 정보 추출
        const urlParams = new URLSearchParams(window.location.search);
        
        const state = {
            firstCategory: urlParams.get('firstCategory') || 'skincare',
            secondCategory: urlParams.get('secondCategory') || 'none',
            thirdCategory: urlParams.get('thirdCategory') || 'none',
            page: parseInt(urlParams.get('page') || '0', 10),
            size: parseInt(urlParams.get('size') || '24', 10),
            sort: urlParams.get('sort') || 'POPULAR'
        };
        
        // 페이지 제목과 브레드크럼 업데이트
        document.addEventListener('DOMContentLoaded', function() {
            updatePageInfo();
            updateCategoryFilter();
        });

        // API 엔드포인트 (실제 경로로 변경 가능)
        // 사용자 요청: localhost:8080/api/products 사용
        const API_ENDPOINT = '/api/categories/products';

        const $grid = document.getElementById('product-grid');
        const $pgn  = document.getElementById('pagination');
        const $cnt  = document.getElementById('result-count');
        
        // 페이지 정보 업데이트 함수
        function updatePageInfo() {
            // 브레드크럼 업데이트
            const breadcrumbs = document.querySelector('.breadcrumbs');
            let breadcrumbText = state.firstCategory;
            if (state.secondCategory && state.secondCategory !== 'none') {
                breadcrumbText += ' > ' + state.secondCategory;
                if (state.thirdCategory && state.thirdCategory !== 'none') {
                    breadcrumbText += ' > ' + state.thirdCategory;
                }
            }
            breadcrumbs.textContent = breadcrumbText;
            
            // 페이지 제목 업데이트 (3차 > 2차 > 1차 우선순위)
            const pageTitle = document.querySelector('.page-title');
            let displayCategory;
            
            if (state.thirdCategory && state.thirdCategory !== 'none') {
                displayCategory = state.thirdCategory;
            } else if (state.secondCategory && state.secondCategory !== 'none') {
                displayCategory = state.secondCategory;
            } else {
                displayCategory = state.firstCategory;
            }
            
            pageTitle.textContent = displayCategory;
            
            // 페이지 제목 태그 업데이트
            document.title = displayCategory + ' - PERSOME';
        }

        // 정렬 탭
        document.getElementById('sort-tabs').addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            document.querySelectorAll('#sort-tabs button').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            state.sort = e.target.dataset.sort;
            state.page = 0;
            load();
        });

        // VIEW 24/36
        document.querySelectorAll('.view-size button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.view-size button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.size = parseInt(btn.dataset.size, 10);
                state.page = 0;
                load();
            });
        });

        // 2차 카테고리별 3차 카테고리 매핑 (SQL 분석 기반)
        const thirdCategoryMapping = {
            '스킨/토너': [
                { value: 'all', text: '전체' },
                { value: '스킨/토너', text: '스킨/토너' }
            ],
            '에센스/세럼/앰플': [
                { value: 'all', text: '전체' },
                { value: '에센스/세럼/앰플', text: '에센스/세럼/앰플' }
            ],
            '크림': [
                { value: 'all', text: '전체' },
                { value: '크림', text: '크림' },
                { value: '아이크림', text: '아이크림' }
            ],
            '로션': [
                { value: 'all', text: '전체' },
                { value: '로션', text: '로션' },
                { value: '올인원', text: '올인원' }
            ],
            '미스트/오일': [
                { value: 'all', text: '전체' },
                { value: '미스트/픽서', text: '미스트/픽서' },
                { value: '페이스오일', text: '페이스오일' }
            ],
            '스킨케어세트': [
                { value: 'all', text: '전체' },
                { value: '스킨케어세트', text: '스킨케어세트' }
            ],
            '스킨케어 디바이스': [
                { value: 'all', text: '전체' },
                { value: '스킨케어 디바이스', text: '스킨케어 디바이스' }
            ]
        };

        // 카테고리 필터 업데이트 함수
        function updateCategoryFilter() {
            const categoryFilter = document.getElementById('category-filter');
            const categoryTabs = document.getElementById('category-tabs');
            
            // 2차 카테고리가 없거나 매핑이 없으면 숨김
            if (!state.secondCategory || state.secondCategory === 'none' || !thirdCategoryMapping[state.secondCategory]) {
                categoryFilter.style.display = 'none';
                return;
            }
            
            categoryFilter.style.display = 'block';
            
            // 해당 2차 카테고리의 3차 카테고리들로 탭 업데이트
            const thirdCategories = thirdCategoryMapping[state.secondCategory];
            const tabsHtml = thirdCategories.map(cat => 
                `<button data-category="${cat.value}" class="${cat.value === (state.thirdCategory || 'all') ? 'active' : ''}">${cat.text}</button>`
            ).join('');
            
            categoryTabs.innerHTML = tabsHtml;
            
            // 이벤트 리스너 다시 등록
            categoryTabs.addEventListener('click', handleCategoryClick);
        }

        // 카테고리 클릭 핸들러
        function handleCategoryClick(e) {
            if (e.target.tagName !== 'BUTTON') return;
            
            // 활성화 상태 변경
            document.querySelectorAll('#category-tabs button').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            
            // 상태 업데이트
            const selectedCategory = e.target.dataset.category;
            state.thirdCategory = selectedCategory === 'all' ? 'none' : selectedCategory;
            state.page = 0;
            
            // 페이지 정보 업데이트 (제목과 브레드크럼)
            updatePageInfo();
            
            // 상품 다시 로드
            load();
        }

        function qs(params) {
            const p = new URLSearchParams();
            p.set('firstCategory', state.firstCategory);
            p.set('secondCategory', state.secondCategory || 'none');
            p.set('thirdCategory', state.thirdCategory || 'none');
            p.set('page', state.page);
            p.set('size', state.size);
            if (state.sort) p.set('sort', state.sort);
            return p.toString();
        }

        async function load() {
            try {
                const url = `${API_ENDPOINT}?${qs()}`;
                const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
                if (!res.ok) throw new Error('API 호출 실패: ' + res.status);
                const json = await res.json(); // PageProductAllResponse

                console.log("resp data : ", json);

                renderCount(json);
                renderProducts(json.products || []);
                renderPagination(json);
            } catch (err) {
                console.error(err);
                $grid.innerHTML = '<p>상품을 불러오지 못했습니다. 잠시 후 다시 시도해주세요.</p>';
            }
        }

        function renderCount(p) {
            const total = p.totalElements ?? 0;
            const catName = (state.secondCategory && state.secondCategory !== 'none') ? state.secondCategory : state.firstCategory;
            $cnt.textContent = `${catName} 카테고리에 ${total}개의 상품이 등록되어 있습니다.`;
        }

        function currency(n) {
            if (n == null) return '';
            return n.toLocaleString('ko-KR');
        }

        function primaryImage(imgs = []) {
            if (!Array.isArray(imgs) || !imgs.length) {
                return '/images/noimg.png';
            }
            const sorted = [...imgs].sort((a, b) => (a?.imgOrder ?? 0) - (b?.imgOrder ?? 0));
            return sorted[0]?.imgUrl || '/images/noimg.png';
        }

        function resolvePrice(priceList = []) {
            if (!Array.isArray(priceList) || !priceList.length) {
                return { salePrice: null, originalPrice: null };
            }
            const salePrice = priceList.find(p => p?.type === 'SALE')?.price ?? null;
            const originalPrice = priceList.find(p => p?.type === 'ORIGINAL')?.price ?? null;

            if (salePrice != null) {
                return { salePrice, originalPrice: originalPrice ?? salePrice };
            }

            return { salePrice: originalPrice, originalPrice: null };
        }

        function renderProducts(list) {
            if (!list.length) {
                $grid.innerHTML = '<p>상품이 없습니다.</p>';
                return;
            }
            const html = list.map(p => {
                const { salePrice, originalPrice } = resolvePrice(p.price);
                const img = primaryImage(p.imgs);
                const priceText = salePrice != null ? `${currency(salePrice)}원` : '';
                const original = (salePrice != null && originalPrice != null && originalPrice > salePrice)
                    ? `<span class="original">${currency(originalPrice)}원</span>` : '';
                const badges = [
                    p.onSale ? '<span class="badge">세일</span>' : '',
                    p.hasCoupon ? '<span class="badge">쿠폰</span>' : '',
                    p.hasGift ? '<span class="badge">증정</span>' : '',
                    p.todayDelivery ? '<span class="badge">오늘드림</span>' : ''
                ].join('');

                return `
                <div class="card">
                    <a href="/products/${p.product_id}">
                        <img class="thumb" src="${img}" alt="상품 이미지"/>
                    </a>
                    <a href="/products/${p.product_id}" class="brand">${p.brandName ?? ''}</a>
                    <a href="/products/${p.product_id}" class="name">${escapeHtml(p.name ?? '')}</a>
                    <div class="price-area">
                        <span class="price">${priceText}</span>
                        ${original}
                    </div>
                    <div class="badges">${badges}</div>
                    <div class="actions">
                        <!--<button class="btn">장바구니</button>
                        <button class="btn primary">바로구매</button>-->
                    </div>
                </div>
            `;
            }).join('');
            $grid.innerHTML = html;
        }

        function renderPagination(p) {
            const cur = p.currentPage ?? 0;
            const totalPages = p.totalPages ?? 0;

            if (totalPages <= 1) {
                $pgn.innerHTML = '';
                return;
            }

            let buttons = '';
            if (p.hasPrevious) {
                buttons += `<button data-page="${cur-1}">이전</button>`;
            }

            const windowSize = 5;
            const start = Math.max(0, Math.min(cur - Math.floor(windowSize/2), totalPages - windowSize));
            const end = Math.min(totalPages, start + windowSize);

            for (let i = start; i < end; i++) {
                buttons += `<button data-page="${i}" class="${i===cur ? 'active':''}">${i+1}</button>`;
            }

            if (p.hasNext) {
                buttons += `<button data-page="${cur+1}">다음</button>`;
            }

            $pgn.innerHTML = buttons;

            $pgn.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const to = parseInt(btn.dataset.page, 10);
                    if (!isNaN(to)) {
                        state.page = to;
                        load();
                    }
                });
            });
        }

        function escapeHtml(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        // 초기 로드
        load();
    })();
</script>
</body>
</html>
