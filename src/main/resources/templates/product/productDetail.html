<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/header.css">
    <title>상품 상세 - PERSOME</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Breadcrumb */
        .breadcrumb { padding: 15px 0; font-size: 14px; color: #666; }
        .breadcrumb a { color: #666; text-decoration: none; }
        .breadcrumb a:hover { color: #7B68EE; }
        
        /* Product Detail */
        .product-detail { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin: 20px 0; }
        
        /* Product Images */
        .product-images { position: relative; }
        .main-image-container { position: relative; display: inline-block; }
        .main-image { width: 100%; max-width: 500px; border-radius: 10px; margin-bottom: 15px; }
        .image-nav-btn { 
            position: absolute; 
            top: 50%; 
            transform: translateY(-50%); 
            background: rgba(0,0,0,0.5); 
            color: white; 
            border: none; 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 18px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            z-index: 10;
            transition: background 0.3s;
        }
        .image-nav-btn:hover { background: rgba(0,0,0,0.7); }
        .image-nav-btn.prev { left: 10px; }
        .image-nav-btn.next { right: 10px; }
        .image-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .image-thumbnails { display: flex; gap: 10px; flex-wrap: wrap; }
        .thumbnail { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; cursor: pointer; border: 2px solid transparent; }
        .thumbnail:hover, .thumbnail.active { border-color: #7B68EE; }
        
        /* Product Info */
        .product-info { padding: 20px 0; }
        .brand-badge { background: #f0f0f0; color: #666; padding: 5px 10px; border-radius: 15px; font-size: 12px; margin-bottom: 10px; display: inline-block; }
        .product-title { font-size: 24px; font-weight: bold; margin: 15px 0; line-height: 1.4; }
        .rating { display: flex; align-items: center; margin: 10px 0; }
        .stars { color: #ff6b6b; margin-right: 10px; }
        .rating-text { color: #666; font-size: 14px; }
        
        /* Pricing */
        .pricing { margin: 20px 0; }
        .original-price { color: #999; text-decoration: line-through; font-size: 16px; }
        .current-price { font-size: 28px; font-weight: bold; color: #ff6b6b; margin: 5px 0; }
        .discount-badge { background: #ff6b6b; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px; margin-left: 10px; }
        
        /* Options */
        .options { margin: 25px 0; }
        .option-group { margin: 15px 0; }
        .option-label { font-weight: bold; margin-bottom: 8px; display: block; }
        .option-select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .stock-status { font-size: 12px; color: #28a745; margin-top: 5px; }
        .stock-status.out-of-stock { color: #dc3545; }
        
        /* Quantity */
        .quantity-section { margin: 20px 0; }
        .quantity-controls { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .quantity-btn { width: 35px; height: 35px; border: 1px solid #ddd; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .quantity-btn:hover { background: #f5f5f5; }
        .quantity-input { width: 60px; text-align: center; padding: 8px; border: 1px solid #ddd; }
        
        /* Action Buttons */
        .action-buttons { margin: 30px 0; display: flex; gap: 15px; }
        .btn { padding: 15px 30px; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; flex: 1; }
        .btn-cart { background: white; color: #7B68EE; border: 2px solid #7B68EE; }
        .btn-cart:hover { background: #f8f7ff; }
        .btn-buy { background: #7B68EE; color: white; }
        .btn-buy:hover { background: #6a5acd; }
        .btn-wishlist {
            position: relative;        /* 중앙 배치 기준 */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            max-width: 60px;
            height: 55px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            color: #333;
        }
        .btn-wishlist:hover { background: #f5f5f5; }
        .btn-wishlist .heart {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 20px;
            height: 18px;
            transform: translate(-50%, -50%);
            color: currentColor;
        }
        .btn-wishlist .heart:before,
        .btn-wishlist .heart:after {
            content: '';
            width: 12px;
            height: 20px;
            position: absolute;
            left: 10px;
            top: 0;
            background: currentColor;
            border-radius: 10px 10px 0 0;
            transform: rotate(-45deg);
            transform-origin: 0 100%;
        }
        .btn-wishlist .heart:after {
            left: 0;
            transform: rotate(45deg);
            transform-origin: 100% 100%;
        }
        .btn-wishlist.wishlisted .heart { color: #ff4757; }
        
        /* Promotion Banner */
        .promotion-banner { background: linear-gradient(135deg, #a8e6cf, #88d8a3); border-radius: 10px; padding: 20px; margin: 20px 0; text-align: center; }
        .promotion-title { font-size: 18px; font-weight: bold; color: #2d5016; margin-bottom: 10px; }
        .promotion-desc { color: #2d5016; font-size: 14px; }
        
        /* Product Details */
        .product-details { margin-top: 40px; }
        .tab-navigation { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .tab { padding: 15px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom-color: #7B68EE; color: #7B68EE; font-weight: bold; }
        .tab-content { padding: 20px 0; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .product-detail { grid-template-columns: 1fr; gap: 20px; }
            .action-buttons { flex-direction: column; }
            .btn { padding: 12px 20px; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header"></div>

    <div class="container">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <a href="/">홈</a> >
            <a href="/category">대분류</a> >
            <a href="/category">중분류</a> >
            <span>소분류</span>
        </div>

        <!-- Product Detail -->
        <div class="product-detail">
            <!-- Product Images -->
            <div class="product-images">
                <div class="main-image-container">
                    <img src="/images/no-image.jpg" alt="상품 이미지" class="main-image" id="mainImage">
                    <button class="image-nav-btn prev" id="prevBtn" onclick="navigateImage(-1)">‹</button>
                    <button class="image-nav-btn next" id="nextBtn" onclick="navigateImage(1)">›</button>
                </div>
                <div class="image-thumbnails">
                    <!-- 이미지들이 JavaScript로 동적 생성됩니다 -->
                </div>
            </div>

            <!-- Product Info -->
            <div class="product-info">
                <span class="brand-badge">VT</span>
                
                <h1 class="product-title">
                    상품명
                </h1>
                
                <div class="rating">
                    <div class="stars">
                        <span>★</span><span>★</span><span>★</span><span>★</span><span>☆</span>
                    </div>
                    <span class="rating-text">평점</span>
                </div>

                <!-- Pricing -->
                <div class="pricing">
                    <div>
                        <span class="original-price">정가</span>
                    </div>
                    <div class="current-price">
                        <span>할인가</span>
                        <span class="discount-badge">할인중</span>
                    </div>
                </div>

                <!-- Options -->
                <div class="options">
                    <div class="option-group">
                        <label class="option-label">옵션 선택</label>
                        <select class="option-select" id="optionSelect">
                            <option value="">옵션을 선택해 주세요</option>
                        </select>
                        <div class="stock-status">
                            <span>배송비 포함</span>
                        </div>
                    </div>
                </div>

                <!-- Quantity -->
                <div class="quantity-section">
                    <label class="option-label">구매수량</label>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="changeQuantity(-1)">-</button>
                        <input type="number" class="quantity-input" value="1" min="1" id="quantity">
                        <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
                    </div>
                </div>

                <!-- Total Price -->
                <div class="pricing">
                    <div class="current-price">
                        상품금액 합계: <span id="totalPrice">21,100원</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-cart" onclick="addToCart()">장바구니</button>
                    <button class="btn btn-buy" onclick="buyNow()">바로구매</button>
                    <button class="btn btn-wishlist" id="wishlistBtn" onclick="toggleWishlist()">
                        <div class="heart"></div>
                    </button>
                </div>

                <!-- Promotion Banner -->
                <div class="promotion-banner">
                    <div class="promotion-title">100% 당첨 리뷰이벤트</div>
                    <div class="promotion-desc">리뷰 작성 시 5천원 할인쿠폰 지급!</div>
                </div>
            </div>
        </div>

        <!-- Product Details Tabs -->
        <div class="product-details">
            <div class="tab-navigation">
                <div class="tab active" onclick="showTab('description')">상품설명</div>
                <div class="tab" onclick="showTab('details')">구매정보</div>
                <div class="tab" onclick="showTab('reviews')">리뷰 (33,227)</div>
                <div class="tab" onclick="showTab('qna')">Q&A (25)</div>
            </div>
            
            <div class="tab-content" id="description">
                <div>
                    상품설명 영역
                </div>
            </div>
            
            <div class="tab-content" id="details" style="display: none;">
                <p><strong>브랜드:</strong> <span>VT COSMETICS</span></p>
                <!--<p><strong>제조국:</strong> 대한민국</p>
                <p><strong>제조사:</strong> 코스맥스</p>-->
                <p><strong>상품상태:</strong> <span>판매중</span></p>
            </div>
            
            <div class="tab-content" id="reviews" style="display: none;">
                <p>리뷰 목록이 여기에 표시됩니다.</p>
            </div>
            
            <div class="tab-content" id="qna" style="display: none;">
                <p>Q&A 목록이 여기에 표시됩니다.</p>
            </div>
        </div>
    </div>
    <script src="/js/header.js"></script>
    <script>
        let productData = null;
        let currentPrice = 0;
        let currentImageIndex = 0;
        let imageList = [];
        let isWishlisted = false;

        // 페이지 로드 시 상품 데이터 가져오기
        document.addEventListener('DOMContentLoaded', function() {
            console.log('페이지 로드됨');
            console.log('현재 URL:', window.location.href);
            console.log('Pathname:', window.location.pathname);
            
            const productId = getProductIdFromUrl();
            console.log('추출된 상품 ID:', productId);
            
            if (productId) {
                console.log('상품 데이터 로드 시작:', productId);
                loadProductData(productId);
            } else {
                console.error('상품 ID를 찾을 수 없습니다.');
                console.log('URL 구조를 확인하세요. 예: /product/123 또는 /products/123 또는 /product?productId=123');
            }
        });

        // URL에서 상품 ID 추출
        function getProductIdFromUrl() {
            const pathParts = window.location.pathname.split('/');
            console.log('경로 분할:', pathParts);
            
            // /product/123 형태
            const productIndex = pathParts.indexOf('product');
            console.log('product 인덱스:', productIndex);
            
            if (productIndex !== -1 && pathParts[productIndex + 1]) {
                const id = pathParts[productIndex + 1];
                console.log('경로에서 찾은 ID (product):', id);
                return id;
            }
            
            // /products/123 형태 (현재 URL 구조)
            const productsIndex = pathParts.indexOf('products');
            console.log('products 인덱스:', productsIndex);
            
            if (productsIndex !== -1 && pathParts[productsIndex + 1]) {
                const id = pathParts[productsIndex + 1];
                console.log('경로에서 찾은 ID (products):', id);
                return id;
            }
            
            // URL 파라미터에서 찾기 (예: ?productId=123)
            const urlParams = new URLSearchParams(window.location.search);
            const paramId = urlParams.get('productId');
            console.log('파라미터에서 찾은 ID:', paramId);
            return paramId;
        }

        // 서버에서 상품 데이터 로드
        async function loadProductData(productId) {
            try {
                console.log('API 호출 시작:', `/api/products/${productId}`);
                showLoading(true);
                
                const response = await fetch(`/api/products/${productId}`);
                console.log('응답 상태:', response.status);
                console.log('응답 헤더:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                productData = await response.json();
                console.log('받은 데이터:', productData);
                renderProductData(productData);
                
                // 위시리스트 상태 확인
                await checkWishlistStatus(productId);
                showLoading(false);
                
            } catch (error) {
                console.error('상품 데이터 로드 실패:', error);
                showError('상품 정보를 불러오는데 실패했습니다.');
                showLoading(false);
            }
        }

        // 상품 데이터를 화면에 렌더링
        function renderProductData(product) {
            console.log('렌더링 시작:', product);
            
            // 페이지 제목 설정
            document.title = `${product.name} - PERSOME`;
            
            // Breadcrumb 설정
            updateBreadcrumb(product);
            
            // 상품 이미지 설정
            updateProductImages(product.images);
            
            // 브랜드 및 상품명
            const brandBadge = document.querySelector('.brand-badge');
            const productTitle = document.querySelector('.product-title');
            
            if (brandBadge) brandBadge.textContent = product.brandName;
            if (productTitle) productTitle.textContent = product.name;
            
            // 평점 설정
            updateRating(product.ratingAvg);
            
            // 가격 설정
            updatePricing(product.prices);
            
            // 옵션 설정
            updateOptions(product.options);
            
            // 상품 설명 설정
            const descDiv = document.querySelector('#description div');
            if (descDiv) {
                descDiv.innerHTML = product.description.replace(/\n/g, '<br>');
            }
            
            // 구매정보 탭 설정
            updateProductDetails(product);
            
            console.log('렌더링 완료');
        }

        // Breadcrumb 업데이트
        function updateBreadcrumb(product) {
            const breadcrumb = document.querySelector('.breadcrumb');
            if (breadcrumb) {
                breadcrumb.innerHTML = `
                    <a href="/">홈</a> >
                    <a href="/categories/products?firstCategory=${encodeURIComponent(product.firstCategory)}">${product.firstCategory}</a> >
                    <a href="/categories/products?firstCategory=${encodeURIComponent(product.firstCategory)}&secondCategory=${encodeURIComponent(product.secondCategory)}">${product.secondCategory}</a> > 
                    <span>${product.thirdCategory}</span>
                `;
            } else {
                console.error('Breadcrumb 요소를 찾을 수 없습니다.');
            }
        }

        // 상품 이미지 업데이트
        function updateProductImages(images) {
            if (!images || images.length === 0) {
                document.querySelector('.main-image').src = '/images/no-image.jpg';
                imageList = [];
                updateNavigationButtons();
                return;
            }

            // 이미지를 순서대로 정렬
            images.sort((a, b) => a.imgOrder - b.imgOrder);
            imageList = images;
            currentImageIndex = 0;
            
            // 메인 이미지 설정
            document.querySelector('.main-image').src = images[0].imgUrl;
            
            // 썸네일 이미지 생성
            const thumbnailContainer = document.querySelector('.image-thumbnails');
            if (thumbnailContainer) {
                thumbnailContainer.innerHTML = '';
                
                images.forEach((image, index) => {
                    const thumbnail = document.createElement('img');
                    thumbnail.src = image.imgUrl;
                    thumbnail.alt = `상품 이미지 ${index + 1}`;
                    thumbnail.className = index === 0 ? 'thumbnail active' : 'thumbnail';
                    thumbnail.onclick = () => changeMainImageByIndex(index);
                    thumbnailContainer.appendChild(thumbnail);
                });
            }
            
            // 네비게이션 버튼 상태 업데이트
            updateNavigationButtons();
        }

        // 이미지 인덱스로 메인 이미지 변경
        function changeMainImageByIndex(index) {
            if (index >= 0 && index < imageList.length) {
                currentImageIndex = index;
                const mainImage = document.getElementById('mainImage');
                if (mainImage) {
                    mainImage.src = imageList[index].imgUrl;
                }
                
                // 썸네일 활성화 상태 업데이트
                updateThumbnailActive();
                updateNavigationButtons();
            }
        }

        // 이미지 네비게이션 (좌우 버튼)
        function navigateImage(direction) {
            const newIndex = currentImageIndex + direction;
            if (newIndex >= 0 && newIndex < imageList.length) {
                changeMainImageByIndex(newIndex);
            }
        }

        // 썸네일 활성화 상태 업데이트
        function updateThumbnailActive() {
            const thumbnails = document.querySelectorAll('.thumbnail');
            thumbnails.forEach((thumb, index) => {
                if (index === currentImageIndex) {
                    thumb.classList.add('active');
                } else {
                    thumb.classList.remove('active');
                }
            });
        }

        // 네비게이션 버튼 상태 업데이트
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn && nextBtn) {
                // 이미지가 1개 이하면 버튼 숨기기
                if (imageList.length <= 1) {
                    prevBtn.style.display = 'none';
                    nextBtn.style.display = 'none';
                    return;
                }
                
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
                
                // 첫 번째 이미지면 이전 버튼 비활성화
                prevBtn.disabled = (currentImageIndex === 0);
                
                // 마지막 이미지면 다음 버튼 비활성화
                nextBtn.disabled = (currentImageIndex === imageList.length - 1);
            }
        }

        // 평점 업데이트
        function updateRating(ratingAvg) {
            const starsContainer = document.querySelector('.stars');
            const ratingText = document.querySelector('.rating-text');
            
            if (starsContainer) {
                starsContainer.innerHTML = '';
                
                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('span');
                    star.textContent = i <= ratingAvg ? '★' : '☆';
                    starsContainer.appendChild(star);
                }
            }
            
            if (ratingText) {
                ratingText.textContent = `${ratingAvg}점`;
            }
        }

        // 가격 정보 업데이트
        function updatePricing(prices) {
            if (!prices || prices.length === 0) return;
            
            const pricingContainer = document.querySelector('.pricing');
            if (!pricingContainer) return;
            
            // 할인가가 있는 경우
            if (prices.length > 1) {
                const originalPrice = prices[0].price;
                const currentPriceData = prices[prices.length - 1];
                currentPrice = currentPriceData.price;
                
                pricingContainer.innerHTML = `
                    <div>
                        <span class="original-price">${originalPrice.toLocaleString()}원</span>
                    </div>
                    <div class="current-price">
                        <span>${currentPrice.toLocaleString()}원</span>
                        <span class="discount-badge">할인중</span>
                    </div>
                `;
            } else {
                currentPrice = prices[0].price;
                pricingContainer.innerHTML = `
                    <div class="current-price">
                        <span>${currentPrice.toLocaleString()}원</span>
                    </div>
                `;
            }
            
            // 총 금액 초기화
            updateTotalPrice();
        }

        // 옵션 업데이트
        function updateOptions(options) {
            const optionGroup = document.querySelector('.option-group');
            
            if (!options || options.length === 0) {
                if (optionGroup) optionGroup.style.display = 'none';
                return;
            }
            
            const optionSelect = document.querySelector('#optionSelect');
            if (!optionSelect) return;
            
            optionSelect.innerHTML = '<option value="">옵션을 선택해 주세요</option>';
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.option_id;
                optionElement.textContent = option.name + 
                    (option.additionalAmount > 0 ? ` (+${option.additionalAmount}원)` : '');
                optionSelect.appendChild(optionElement);
            });
            
            // 옵션 변경 이벤트 리스너 추가
            optionSelect.addEventListener('change', function() {
                updateStockInfo(this.value, options);
                updatePriceWithOption(this.value, options);
            });
            
            // 초기 재고 상태 표시 (첫 번째 옵션 또는 기본값)
            updateStockInfo('', options);
        }

        // 재고 정보 업데이트
        function updateStockInfo(selectedOptionId, options) {
            const stockStatusElement = document.querySelector('.stock-status');
            if (!stockStatusElement) return;
            
            if (!selectedOptionId) {
                // 옵션이 선택되지 않은 경우 - 기본 메시지 또는 첫 번째 옵션 정보
                stockStatusElement.innerHTML = '<span>옵션을 선택해 주세요</span>';
                return;
            }
            
            // 선택된 옵션 찾기
            const selectedOption = options.find(option => option.option_id == selectedOptionId);
            
            if (selectedOption && selectedOption.inventories && selectedOption.inventories.length > 0) {
                const inventory = selectedOption.inventories[0];
                stockStatusElement.innerHTML = `
                    <span>${inventory.stockStatus}</span>
                    ${inventory.quantity ? `<span>(재고: ${inventory.quantity}개)</span>` : ''}
                `;
                
                // 재고 상태에 따른 스타일 적용
                if (inventory.stockStatus === 'OUT_OF_STOCK' || inventory.quantity === 0) {
                    stockStatusElement.className = 'stock-status out-of-stock';
                } else {
                    stockStatusElement.className = 'stock-status';
                }
            } else {
                stockStatusElement.innerHTML = '<span>재고 정보 없음</span>';
            }
        }

        // 옵션에 따른 가격 업데이트
        function updatePriceWithOption(selectedOptionId, options) {
            if (!selectedOptionId) {
                // 기본 가격으로 복원
                updateTotalPrice();
                return;
            }
            
            const selectedOption = options.find(option => option.option_id == selectedOptionId);
            if (selectedOption && selectedOption.additionalAmount) {
                // 추가 금액이 있는 경우 총 가격에 반영
                updateTotalPrice(selectedOption.additionalAmount);
            } else {
                updateTotalPrice();
            }
        }

        // 구매정보 탭 업데이트
        function updateProductDetails(product) {
            document.querySelector('#details').innerHTML = `
                <p><strong>브랜드:</strong> ${product.brandName}</p>
                <p><strong>제조국:</strong> 대한민국</p>
                <p><strong>제조사:</strong> 코스맥스</p>
                <p><strong>상품상태:</strong> ${product.status}</p>
            `;
        }

        // 로딩 상태 표시
        function showLoading(show) {
            let loadingDiv = document.getElementById('loading-overlay');
            
            if (show) {
                // 로딩 오버레이가 없으면 생성
                if (!loadingDiv) {
                    loadingDiv = document.createElement('div');
                    loadingDiv.id = 'loading-overlay';
                    loadingDiv.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(255, 255, 255, 0.8);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 9999;
                    `;
                    loadingDiv.innerHTML = `
                        <div style="text-align: center;">
                            <h2>상품 정보를 불러오는 중...</h2>
                            <div style="margin-top: 20px;">
                                <div style="border: 4px solid #f3f3f3; border-top: 4px solid #7B68EE; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto;"></div>
                            </div>
                        </div>
                        <style>
                            @keyframes spin {
                                0% { transform: rotate(0deg); }
                                100% { transform: rotate(360deg); }
                            }
                        </style>
                    `;
                    document.body.appendChild(loadingDiv);
                }
                loadingDiv.style.display = 'flex';
            } else {
                // 로딩 숨기기
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
            }
        }

        // 에러 메시지 표시
        function showError(message) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div style="text-align: center; padding: 100px;">
                    <h2 style="color: #dc3545;">오류가 발생했습니다</h2>
                    <p style="margin-top: 20px; color: #666;">${message}</p>
                    <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #7B68EE; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        다시 시도
                    </button>
                </div>
            `;
        }

        // 메인 이미지 변경 (기존 호환성을 위해 유지)
        function changeMainImage(src) {
            // URL로 이미지 인덱스 찾기
            const index = imageList.findIndex(img => img.imgUrl === src);
            if (index !== -1) {
                changeMainImageByIndex(index);
            }
        }

        // 수량 변경
        function changeQuantity(delta) {
            const quantityInput = document.getElementById('quantity');
            const currentQuantity = parseInt(quantityInput.value);
            const newQuantity = Math.max(1, currentQuantity + delta);
            quantityInput.value = newQuantity;
            updateTotalPrice();
        }

        // 총 금액 업데이트
        function updateTotalPrice(additionalAmount = 0) {
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const basePrice = currentPrice + additionalAmount;
            const totalPrice = basePrice * quantity;
            const totalPriceElement = document.getElementById('totalPrice');
            if (totalPriceElement) {
                totalPriceElement.textContent = totalPrice.toLocaleString() + '원';
            }
        }

        // 탭 전환
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).style.display = 'block';
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // 장바구니 추가
        function addToCart() {
            const selectedOption = getSelectedOption();
            if (!validateSelection(selectedOption)) return;
            
            const cartData = {
                productId: productData.product_id,
                optionId: selectedOption.optionId,
                quantity: parseInt(document.getElementById('quantity').value) || 1
            };
            
            console.log('장바구니 추가:', cartData);
            // TODO: 실제 장바구니 API 호출
            alert('장바구니에 추가되었습니다.');
        }

        // 바로구매
        function buyNow() {
            const selectedOption = getSelectedOption();
            if (!validateSelection(selectedOption)) return;
            
            const orderData = {
                productId: productData.product_id,
                optionId: selectedOption.optionId,
                quantity: parseInt(document.getElementById('quantity').value) || 1
            };
            
            console.log('바로구매:', orderData);
            // TODO: 주문 페이지로 이동
            alert('주문 페이지로 이동합니다.');
        }

        // 위시리스트 상태 확인
        async function checkWishlistStatus(productId) {
            try {
                const response = await fetch(`/api/users/me/wishlist`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const wishlistItems = await response.json();
                    // 현재 상품이 위시리스트에 있는지 확인
                    isWishlisted = wishlistItems.some(item => item.productId == productId);
                    updateWishlistButton();
                } else {
                    // 로그인되지 않았거나 확인 실패시 기본값
                    isWishlisted = false;
                    updateWishlistButton();
                }
            } catch (error) {
                console.error('위시리스트 상태 확인 실패:', error);
                isWishlisted = false;
                updateWishlistButton();
            }
        }

        // 위시리스트 버튼 UI 업데이트
        function updateWishlistButton() {
            const wishlistBtn = document.getElementById('wishlistBtn');
            if (wishlistBtn) {
                if (isWishlisted) {
                    wishlistBtn.classList.add('wishlisted');
                    wishlistBtn.style.borderColor = '#ff4757';
                } else {
                    wishlistBtn.classList.remove('wishlisted');
                    wishlistBtn.style.borderColor = '#333';
                }
            }
        }

        // 위시리스트 토글
        async function toggleWishlist() {
            if (!productData) return;
            
            try {
                if (isWishlisted) {
                    // 위시리스트에서 제거
                    const response = await fetch(`/api/users/me/wishlist/${productData.product_id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        isWishlisted = false;
                        updateWishlistButton();
                        showToast('찜 목록에서 제거되었습니다.');
                    } else if (response.status === 401) {
                        alert('로그인이 필요합니다.');
                    } else {
                        alert('오류가 발생했습니다. 다시 시도해 주세요.');
                    }
                } else {
                    // 위시리스트에 추가
                    const response = await fetch(`/api/users/me/wishlist`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            productId: productData.product_id
                        }),
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        isWishlisted = true;
                        updateWishlistButton();
                        showToast('찜 목록에 추가되었습니다.');
                    } else if (response.status === 401) {
                        alert('로그인이 필요합니다.');
                    } else {
                        alert('오류가 발생했습니다. 다시 시도해 주세요.');
                    }
                }
            } catch (error) {
                console.error('위시리스트 토글 실패:', error);
                alert('오류가 발생했습니다. 다시 시도해 주세요.');
            }
        }

        // 토스트 메시지 표시 (간단한 알림)
        function showToast(message) {
            // 기존 토스트가 있으면 제거
            const existingToast = document.getElementById('toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.id = 'toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #333;
                color: white;
                padding: 12px 20px;
                border-radius: 5px;
                z-index: 10000;
                font-size: 14px;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;

            document.body.appendChild(toast);

            // 애니메이션 효과
            setTimeout(() => {
                toast.style.opacity = '1';
            }, 100);

            // 3초 후 자동 제거
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // 선택된 옵션 정보 가져오기
        function getSelectedOption() {
            const optionSelect = document.getElementById('optionSelect');
            const selectedOptionId = optionSelect ? optionSelect.value : '';
            
            return {
                optionId: selectedOptionId,
                hasOption: productData && productData.options && productData.options.length > 0
            };
        }

        // 선택 검증
        function validateSelection(selectedOption) {
            if (selectedOption.hasOption && !selectedOption.optionId) {
                alert('옵션을 선택해 주세요.');
                return false;
            }
            
            // 재고 확인
            if (selectedOption.optionId) {
                const option = productData.options.find(opt => opt.option_id == selectedOption.optionId);
                if (option && option.inventories && option.inventories.length > 0) {
                    const inventory = option.inventories[0];
                    if (inventory.stockStatus === 'OUT_OF_STOCK' || inventory.quantity === 0) {
                        alert('선택한 옵션이 품절되었습니다.');
                        return false;
                    }
                }
            }
            
            return true;
        }

        // 수량 변경 이벤트 리스너 등록 (DOM 로드 후)
        document.addEventListener('DOMContentLoaded', function() {
            const quantityInput = document.getElementById('quantity');
            if (quantityInput) {
                quantityInput.addEventListener('change', updateTotalPrice);
            }
            
            // 키보드 네비게이션 추가
            document.addEventListener('keydown', function(e) {
                // 입력 필드에 포커스가 있을 때는 키보드 네비게이션 비활성화
                if (document.activeElement.tagName === 'INPUT' || 
                    document.activeElement.tagName === 'TEXTAREA' ||
                    document.activeElement.tagName === 'SELECT') {
                    return;
                }
                
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    navigateImage(-1);
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    navigateImage(1);
                }
            });
        });
    </script>
</body>
</html>