<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/header.css">
    <title>ìƒí’ˆ ìƒì„¸ - PERSOME</title>
    <link rel="stylesheet" href="/css/product/productDetail.css">
    <style>
        /* ë¦¬ë·° ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .reviews-section {
            padding: 20px;
        }
        
        .reviews-summary {
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        
        .average-rating {
            text-align: center;
            padding: 20px;
        }
        
        .rating-score {
            font-size: 48px;
            font-weight: bold;
            color: #A68DC0;
            margin-bottom: 10px;
        }
        
        .rating-stars {
            font-size: 24px;
            color: #ffc107;
            margin-bottom: 10px;
        }
        
        .rating-stars .filled {
            color: #ffc107;
        }
        
        .rating-stars .empty {
            color: #ddd;
        }
        
        .total-reviews {
            font-size: 16px;
            color: #666;
        }
        
        .reviews-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .review-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 20px 0;
        }
        
        .review-item:last-child {
            border-bottom: none;
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .review-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .review-username {
            font-weight: 600;
            color: #333;
        }
        
        .review-option {
            font-size: 14px;
            color: #666;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .review-rating {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .review-stars {
            color: #ffc107;
            font-size: 16px;
        }
        
        .review-date {
            font-size: 14px;
            color: #999;
        }
        
        .review-content {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            margin-bottom: 15px;
        }
        
        .review-images {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .review-image {
            width: 110px;
            height: 110px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .review-image:hover {
            transform: scale(1.1);
        }
        
        .loading-reviews {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .no-reviews {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .no-reviews .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header"></div>

    <div class="container">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <a href="/">í™ˆ</a> >
            <a href="/category">ëŒ€ë¶„ë¥˜</a> >
            <a href="/category">ì¤‘ë¶„ë¥˜</a> >
            <span>ì†Œë¶„ë¥˜</span>
        </div>

        <!-- Product Detail -->
        <div class="product-detail">
            <!-- Product Images -->
            <div class="product-images">
                <div class="main-image-container">
                    <img src="/images/no-image.jpg" alt="ìƒí’ˆ ì´ë¯¸ì§€" class="main-image" id="mainImage">
                    <button class="image-nav-btn prev" id="prevBtn" onclick="navigateImage(-1)">â€¹</button>
                    <button class="image-nav-btn next" id="nextBtn" onclick="navigateImage(1)">â€º</button>
                </div>
                <div class="image-thumbnails">
                    <!-- ì´ë¯¸ì§€ë“¤ì´ JavaScriptë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- Product Info -->
            <div class="product-info">
                <span class="brand-badge">VT</span>
                
                <h1 class="product-title" id="product-title">
                    ìƒí’ˆëª…
                </h1>
                
                <div class="rating">
                    <div class="stars">
                        <span>â˜…</span><span>â˜…</span><span>â˜…</span><span>â˜…</span><span>â˜†</span>
                    </div>
                    <span class="rating-text">í‰ì </span>
                </div>

                <!-- Pricing -->
                <div class="pricing">
                    <div>
                        <span class="original-price">ì •ê°€</span>
                    </div>
                    <div class="current-price">
                        <span>í• ì¸ê°€</span>
                        <span class="discount-badge">í• ì¸ì¤‘</span>
                    </div>
                </div>

                <!-- Options -->
                <div class="options">
                    <div class="option-group">
                        <label class="option-label">ì˜µì…˜ ì„ íƒ</label>
                        <select class="option-select" id="optionSelect">
                            <option value="">ì˜µì…˜ì„ ì„ íƒí•´ ì£¼ì„¸ìš”</option>
                        </select>
                        <div class="stock-status">
                            <span>ë°°ì†¡ë¹„ í¬í•¨</span>
                        </div>
                    </div>
                </div>

                <!-- Quantity -->
                <div class="quantity-section">
                    <label class="option-label">êµ¬ë§¤ìˆ˜ëŸ‰</label>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="changeQuantity(-1)">-</button>
                        <input type="number" class="quantity-input" value="1" min="1" id="quantity">
                        <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
                    </div>
                </div>

                <!-- Total Price -->
                <div class="pricing">
                    <div class="current-price">
                        ìƒí’ˆê¸ˆì•¡ í•©ê³„: <span id="totalPrice">21,100ì›</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-cart" onclick="addToCart()">ì¥ë°”êµ¬ë‹ˆ</button>
                    <button class="btn btn-buy" onclick="buyNow()">ë°”ë¡œêµ¬ë§¤</button>
                    <button class="btn btn-wishlist" id="wishlistBtn" onclick="toggleWishlist()">
                        <div class="heart"></div>
                    </button>
                </div>

                <!-- Promotion Banner -->
                <div class="promotion-banner">
                    <div class="promotion-title">100% ë‹¹ì²¨ ë¦¬ë·°ì´ë²¤íŠ¸</div>
                    <div class="promotion-desc">ë¦¬ë·° ì‘ì„± ì‹œ 5ì²œì› í• ì¸ì¿ í° ì§€ê¸‰!</div>
                </div>
            </div>
        </div>

        <!-- Product Details Tabs -->
        <div class="product-details">
            <div class="tab-navigation">
                <div class="tab active" onclick="showTab('description')">ìƒí’ˆì„¤ëª…</div>
                <div class="tab" onclick="showTab('details')">êµ¬ë§¤ì •ë³´</div>
                <div class="tab" onclick="showTab('reviews')">ë¦¬ë·° (33,227)</div>
                <div class="tab" onclick="showTab('qna')">Q&A (25)</div>
            </div>
            
            <div class="tab-content" id="description">
                <div>
                    ìƒí’ˆì„¤ëª… ì˜ì—­
                </div>
            </div>
            
            <div class="tab-content" id="details" style="display: none;">
                <p><strong>ë¸Œëœë“œ:</strong> <span>VT COSMETICS</span></p>
                <!--<p><strong>ì œì¡°êµ­:</strong> ëŒ€í•œë¯¼êµ­</p>
                <p><strong>ì œì¡°ì‚¬:</strong> ì½”ìŠ¤ë§¥ìŠ¤</p>-->
                <p><strong>ìƒí’ˆìƒíƒœ:</strong> <span>íŒë§¤ì¤‘</span></p>
            </div>
            
            <div class="tab-content" id="reviews" style="display: none;">
                <div class="reviews-section">
                    <div class="reviews-summary">
                        <div class="average-rating">
                            <div class="rating-score" id="averageRating">0.0</div>
                            <div class="rating-stars" id="averageStars">
                                <span>â˜†</span><span>â˜†</span><span>â˜†</span><span>â˜†</span><span>â˜†</span>
                            </div>
                            <div class="total-reviews" id="totalReviews">0ê°œì˜ ë¦¬ë·°</div>
                        </div>
                    </div>
                    
                    <div class="reviews-list" id="reviewsList">
                        <!-- ë¦¬ë·°ë“¤ì´ JavaScriptë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->
                        <div class="loading-reviews">ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="qna" style="display: none;">
                <p>Q&A ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>
    <script src="/js/header.js"></script>
    <script src="/js/product/productDetail.js"></script>
    <script src="/js/product/wishlist.js"></script>
    <script src="/js/product/cart.js"></script>
    <script src="/js/product/getProduct.js"></script>
    
    <script>
        let currentProductId = null;
        let productReviews = [];
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒí’ˆ ID ì¶”ì¶œ ë° ë¦¬ë·° ë¡œë“œ
        document.addEventListener('DOMContentLoaded', function() {
            // URLì—ì„œ ìƒí’ˆ ID ì¶”ì¶œ (ì˜ˆ: /products/1)
            const pathParts = window.location.pathname.split('/');
            const productIndex = pathParts.indexOf('products');
            if (productIndex !== -1 && pathParts[productIndex + 1]) {
                currentProductId = pathParts[productIndex + 1];
                loadProductReviews();
            }
        });
        
        // ë¦¬ë·° íƒ­ í´ë¦­ ì‹œì—ë„ ë¦¬ë·° ë¡œë“œ
        function showTab(tabName) {
            // ê¸°ì¡´ íƒ­ ë¡œì§ ì‹¤í–‰
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(tabName).style.display = 'block';
            
            // ë¦¬ë·° íƒ­ì¸ ê²½ìš° ë¦¬ë·° ë¡œë“œ
            if (tabName === 'reviews' && currentProductId) {
                loadProductReviews();
            }
        }
        
        // ìƒí’ˆ ë¦¬ë·° ë¡œë“œ
        async function loadProductReviews() {
            try {
                console.log('ë¦¬ë·° ë¡œë“œ ì‹œì‘ - ìƒí’ˆ ID:', currentProductId);
                const response = await fetch(`/reviews/products/${currentProductId}`);
                if (!response.ok) throw new Error('ë¦¬ë·° ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                
                const result = await response.json();
                console.log('ë¦¬ë·° API ì‘ë‹µ:', result);
                productReviews = result.data || [];
                console.log('ë¡œë“œëœ ë¦¬ë·° ê°œìˆ˜:', productReviews.length);
                
                if (productReviews.length > 0) {
                    console.log('ì²« ë²ˆì§¸ ë¦¬ë·° ìƒ˜í”Œ:', productReviews[0]);
                    if (productReviews[0].reviewMediasList && productReviews[0].reviewMediasList.length > 0) {
                        console.log('ì²« ë²ˆì§¸ ë¦¬ë·° ì´ë¯¸ì§€ URL:', productReviews[0].reviewMediasList[0].downloadUrl);
                    }
                }
                
                displayReviews();
                updateReviewsSummary();
                updateTabReviewCount();
                
            } catch (error) {
                console.error('ë¦¬ë·° ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('reviewsList').innerHTML = 
                    '<div class="no-reviews"><div class="icon">ğŸ˜</div><div>ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div></div>';
            }
        }
        
        // ë¦¬ë·° ëª©ë¡ í‘œì‹œ
        function displayReviews() {
            const reviewsList = document.getElementById('reviewsList');
            
            if (productReviews.length === 0) {
                reviewsList.innerHTML = 
                    '<div class="no-reviews"><div class="icon">ğŸ“</div><div>ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>';
                return;
            }
            
            const reviewsHtml = productReviews.map(review => createReviewHtml(review)).join('');
            reviewsList.innerHTML = reviewsHtml;
        }
        
        // ê°œë³„ ë¦¬ë·° HTML ìƒì„±
        function createReviewHtml(review) {
            const stars = generateStars(parseFloat(review.rating));
            const images = review.reviewMediasList && review.reviewMediasList.length > 0 
                ? `<div class="review-images">
                     ${review.reviewMediasList.map(media => 
                         `<img src="${media.downloadUrl}" alt="ë¦¬ë·° ì´ë¯¸ì§€" class="review-image" 
                               onclick="openImageModal('${media.downloadUrl}')"
                               onerror="handleImageError(this)">`
                     ).join('')}
                   </div>`
                : '';
            
            return `
                <div class="review-item">
                    <div class="review-header">
                        <div class="review-user">
                            <span class="review-username">${review.userLoginId}</span>
                            <span class="review-option">${review.productOptionName}</span>
                        </div>
                        <div class="review-rating">
                            <span class="review-stars">${stars}</span>
                            <span class="review-date">${formatDate(review.createdAt)}</span>
                        </div>
                    </div>
                    <div class="review-content">${review.content}</div>
                    ${images}
                </div>
            `;
        }
        
        // ë³„ì  ìƒì„±
        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            
            return 'â˜…'.repeat(fullStars) + 
                   (hasHalfStar ? 'â˜†' : '') + 
                   'â˜†'.repeat(emptyStars);
        }
        
        // í‰ê·  í‰ì  ë° ë¦¬ë·° ìˆ˜ ì—…ë°ì´íŠ¸
        function updateReviewsSummary() {
            if (productReviews.length === 0) {
                document.getElementById('averageRating').textContent = '0.0';
                document.getElementById('averageStars').innerHTML = 'â˜†â˜†â˜†â˜†â˜†';
                document.getElementById('totalReviews').textContent = '0ê°œì˜ ë¦¬ë·°';
                return;
            }
            
            const totalRating = productReviews.reduce((sum, review) => sum + parseFloat(review.rating), 0);
            const averageRating = (totalRating / productReviews.length).toFixed(1);
            
            document.getElementById('averageRating').textContent = averageRating;
            document.getElementById('averageStars').innerHTML = generateStars(parseFloat(averageRating));
            document.getElementById('totalReviews').textContent = `${productReviews.length}ê°œì˜ ë¦¬ë·°`;
        }
        
        // íƒ­ì˜ ë¦¬ë·° ê°œìˆ˜ ì—…ë°ì´íŠ¸
        function updateTabReviewCount() {
            const reviewTab = document.querySelector('.tab[onclick="showTab(\'reviews\')"]');
            if (reviewTab) {
                reviewTab.textContent = `ë¦¬ë·° (${productReviews.length})`;
            }
        }
        
        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
        }
        
        // ì´ë¯¸ì§€ ëª¨ë‹¬ (ê°„ë‹¨í•œ êµ¬í˜„)
        function openImageModal(imageUrl) {
            window.open(imageUrl, '_blank');
        }
        
        // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
        function handleImageError(img) {
            console.log('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', img.src);
            img.style.display = 'none'; // ì‹¤íŒ¨í•œ ì´ë¯¸ì§€ëŠ” ìˆ¨ê¹€
            // ë˜ëŠ” ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ëŒ€ì²´
            // img.src = '/images/no-image.png';
        }
    </script>
</body>
</html>